<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="欢迎访问！">
<meta property="og:type" content="website">
<meta property="og:title" content="天伟小站">
<meta property="og:url" content="http://example.com/page/18/index.html">
<meta property="og:site_name" content="天伟小站">
<meta property="og:description" content="欢迎访问！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="张天伟">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/18/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>天伟小站</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">天伟小站</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">盐城工学院</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/lazyload&%E9%98%B2%E6%8A%96%E5%8A%A8%E5%92%8C%E8%8A%82%E6%B5%81%E9%98%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/lazyload&%E9%98%B2%E6%8A%96%E5%8A%A8%E5%92%8C%E8%8A%82%E6%B5%81%E9%98%80/" class="post-title-link" itemprop="url">07-自定义按键修饰符&自定义指令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:52" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:52+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="lazyload"><a href="#lazyload" class="headerlink" title="lazyload"></a>lazyload</h2><p>用的最多的场景是：</p>
<ul>
<li><p>图片lazyload</p>
</li>
<li><p>组件lazyload</p>
</li>
</ul>
<p>现在一般都单独做css的lazyload或者js的lazyload，因为这种方式，其实还是要加载图片和组件。</p>
<h3 id="图片lazyload"><a href="#图片lazyload" class="headerlink" title="图片lazyload"></a>图片lazyload</h3><p>图片一般是页面最大的资源，所以<strong>非首屏</strong>延迟加载很重要（让首屏尽快显示）。</p>
<h2 id="防抖动（Debouncing）和节流阀（Throtting）"><a href="#防抖动（Debouncing）和节流阀（Throtting）" class="headerlink" title="防抖动（Debouncing）和节流阀（Throtting）"></a>防抖动（Debouncing）和节流阀（Throtting）</h2><p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.css88.com/archives/7010">实例解析防抖动（Debouncing）和节流阀（Throttling）</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/05-%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/05-%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">05-页面渲染性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:52" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:52+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="浏览器渲染过程"><a href="#浏览器渲染过程" class="headerlink" title="浏览器渲染过程"></a>浏览器渲染过程</h2><p><img src="https://img.smyhvae.com/20210114_2115.png"></p>
<ol>
<li><p>浏览器解析 HTML，生成 DOM Tree（Parse HTML）。</p>
</li>
<li><p>浏览器解析 CSS，生成 CSSOM（CSS Object Model）Tree。</p>
</li>
<li><p>JavaScript 会通过 DOM API 和 CSSOM API 来操作 DOM Tree 和 CSS Rule Tree，浏览器将 DOM Tree 和 CSSOM Tree 合成渲染树（Render Tree）。</p>
</li>
<li><p>布局（Layout）：根据生成的 Render Tree，进行回流，以计算每个节点的几何信息（位置、大小、字体样式等等）。</p>
</li>
<li><p>绘制（Painting）：根据渲染树和回流得到的几何信息，得到每个节点的绝对像素。</p>
</li>
<li><p>展示（Display）：将像素发送给图形处理器（GPU），展示在页面上。</p>
</li>
</ol>
<h2 id="页面渲染技术方案总览"><a href="#页面渲染技术方案总览" class="headerlink" title="页面渲染技术方案总览"></a>页面渲染技术方案总览</h2><p><strong>服务端渲染</strong>：</p>
<ul>
<li>  后端同步渲染、同构直出、BigPipe。</li>
</ul>
<p><strong>客户端渲染</strong>：</p>
<ul>
<li><p>  JavaScript 渲染：静态化、前后端分离、单页面应用</p>
</li>
<li><p>  Web App：React、Vue、PWA</p>
</li>
<li><p>  Hybrid App：PhoneGap 、AppCan 等</p>
</li>
<li><p>  跨平台开发：RN 、Flutter 、小程序等。</p>
</li>
<li><p>  原生 App：iOS 、Android</p>
</li>
</ul>
<p>建议：</p>
<ul>
<li>  依赖业务形式、依赖团队规模、依赖技术水平。</li>
</ul>
<h2 id="静态化技术方案"><a href="#静态化技术方案" class="headerlink" title="静态化技术方案"></a>静态化技术方案</h2><p>静态化是使动态化的网站生成静态 HTML 页面以供用户更好访问的技术，一般分为纯动态化和伪动态化。</p>
<p>技术优势：</p>
<ul>
<li><p>  提高了页面访问速度，降低了服务器的负担，因为访问页面时不需要每次去访问数据库。</p>
</li>
<li><p>  提高网站内容被搜索引擎搜索到的几率，因为搜索引擎更喜欢静态页面。</p>
</li>
<li><p>  网站更稳定，如果后端程序、数据库出现问题，会直接影响网站的正常访问，而静态化页面有缓存，更不容易出现问题。</p>
</li>
</ul>
<p>技术不足：</p>
<ul>
<li><p>  服务器存储占用问题，因为页面量级在增加，要占用大量硬盘空间。</p>
</li>
<li><p>  静态页面中的链接更新问题会有死链或者错误链接问题。</p>
</li>
</ul>
<p>技术实现：</p>
<ul>
<li><p>  跑定时任务，将已有的动态内容进行重定，生成静态的 HTML 页面。</p>
</li>
<li><p>  利用模板技术，将模板引擎中模板字符替换为从数据库字段中取出来的值， 同时生成 HTML 文件。</p>
</li>
</ul>
<p>协作方式：</p>
<ul>
<li><p>  前端统一写好带有交互的完整静态页面。</p>
</li>
<li><p>  后端拆分出静态页面文件，并嵌套在后端模板文件中。</p>
</li>
</ul>
<p>选型建议：后端研发人员充分，又需要考虑用户体验、服务器负载的业务。</p>
<h2 id="前后端分离技术与实现"><a href="#前后端分离技术与实现" class="headerlink" title="前后端分离技术与实现"></a>前后端分离技术与实现</h2><p>前后端分离是指研发人员分离、业务代码分离、后端实现业务接口，前端渲染页面。</p>
<p>技术实现：</p>
<ul>
<li><p>  后端只负责功能接口实现，提供按照约定的数据格式并封装好的 API 接口。</p>
</li>
<li><p>  前端负责业务具体实现，获取到 API 接口数据后，进行页面模板拼接和渲染，独立上线。</p>
</li>
</ul>
<p>协作方式：</p>
<ul>
<li><p>  前端负责实现页面前端交互，根据后端 API 接口拼装前端模板。</p>
</li>
<li><p>  后端专注于业务功能实现和 API 接口封装。</p>
</li>
</ul>
<p>技术优势：</p>
<ul>
<li><p>  团队更加专注</p>
</li>
<li><p>  提升了开发效率</p>
</li>
<li><p>  增加代码可维护性</p>
</li>
</ul>
<p>技术架构：</p>
<ul>
<li><p>  后端架构：Java、C++、PHP、 + Nginx，使用微服务（比如 Dubbo 等）等实现业务的解耦，所有的服务使用某种协议提供不同的服务（比如 JSF 等） 。</p>
</li>
<li><p>  前端架构：使用 Angular、React、Vue 前端框架并部署页面至 CDN。</p>
</li>
<li><p>  前端架构 2：使用 Angular、React、Vue 前端框架并部署在 Node Server。</p>
</li>
</ul>
<p>技术不足：</p>
<ul>
<li><p>  因为前端需要负责一大部分业务逻辑实现，和服务端同步、静态化，需要前端人力非常多。</p>
</li>
<li><p>  页面数据异步渲染，不利于 SEO，搜索引擎更喜欢纯静态页面。</p>
</li>
</ul>
<p>选型建议：</p>
<ul>
<li>  这是大型互联网公司正在采用的开发模式，一句话，如果考虑用户体验，以及前端人力够用，就可以积极采用。</li>
</ul>
<h2 id="单页面应用技术方案"><a href="#单页面应用技术方案" class="headerlink" title="单页面应用技术方案"></a>单页面应用技术方案</h2><p>单页应用（single-page application，缩写 SPA），通过动态重写当前页面，来与用户交互，而非传统的从服务器重新加载整个新页面。这种方法在使用过程中不需要重新加载页面，避免了页面之间切换打断用户体验，使应用程序更像一个桌面应用程序。</p>
<p>技术优点：</p>
<ul>
<li><p>  不错的加载速度：用户往往感觉页面加载非常快，因为一进入页面就能看到页面元素；</p>
</li>
<li><p>  良好的交互体验：进行局部渲染，避免不必要的页面间跳转和重复渲染；</p>
</li>
<li><p>  前后端职责分离：前端进行页面交互逻辑，后端负责业务逻辑；</p>
</li>
<li><p>  减轻服务器负载：服务器只处理数据接口输出，不用考虑页面模板渲染和 HTML 展示。</p>
</li>
</ul>
<p>技术缺点：</p>
<ul>
<li><p>  开发成本相对较高</p>
</li>
<li><p>  首次页面加载时间过多</p>
</li>
<li><p>  SEO 难度比较大</p>
</li>
</ul>
<p>技术实现：</p>
<ul>
<li>  使用 React、Vue 框架可以很好的。</li>
</ul>
<h2 id="BigPipe-简介和工作模式"><a href="#BigPipe-简介和工作模式" class="headerlink" title="BigPipe 简介和工作模式"></a>BigPipe 简介和工作模式</h2><p>BigPipe 通过将页面加载到称为 Pagelet 的小部件中，来加快页面渲染速度，并允许浏览器在 PHB 服务器呈现页面的同时，一直请求页面不同区块的结构，类似一个“流”传输管道。</p>
<p><strong>技术实现</strong>：</p>
<ol>
<li><p>浏览器从服务器请求页面。</p>
</li>
<li><p>Server 迅速呈现一个包含 <head> 标记的页面框架，以及一个包含空 div 元素的主体，这些元素充当 Pagelet 的容器。由于该页面尚未完成，因此与浏览器的 HTTP 连接保持打开状态。</p>
</li>
<li><p>浏览器将开始下载 bigpipe.js 文件，然后它将开始呈现页面。</p>
</li>
<li><p>PHP 服务器进程仍在执行，并且一次构建每个 Pagelet 。Pagelet 完成后，其结果将在<code>&lt;script&gt; BigPipe.onArrive（…）&lt;/ script&gt;</code> 标记内发送到浏览器。</p>
</li>
<li><p>浏览器将收到的 html 代码注入正确的位置。如果小页面需要任何 CSS 资源，则也将下载这些 CSS 资源。</p>
</li>
<li><p>接收完所有的页面集之后，浏览器将开始加载那些页面集所需的所有外部 JavaScript 文件。</p>
</li>
<li><p>下载 JavaScript 后，浏览器将执行所有内联 JavaScript。</p>
</li>
</ol>
<h2 id="同构直出技术方案"><a href="#同构直出技术方案" class="headerlink" title="同构直出技术方案"></a>同构直出技术方案</h2><p>一套代码既可以在服务端运行又可以在客户端运行，这就是同构（Universal）。</p>
<p>技术优势：</p>
<ul>
<li><p>  性能: 降低首屏渲染时间</p>
</li>
<li><p>  SEO: 服务端渲染对搜索引擎的爬取有着天然的优势</p>
</li>
<li><p>  兼容性: 有效规避客户端兼容性问题，比如白屏</p>
</li>
<li><p>  代码同构：直接上线两个版本，利于灾备。</p>
</li>
</ul>
<p>技术实现：</p>
<ul>
<li><p>  next.js：服务器端渲染 React 组件框架（参考查看：<a target="_blank" rel="noopener" href="https://nextjs.org/%EF%BC%89">https://nextjs.org/）</a>, React 采用 ReactDOMServer 调用 renderToString() 方法。</p>
</li>
<li><p>  gatsbyjs：服务端 React 渲染框架（参考查看： <a target="_blank" rel="noopener" href="https://www.gatsbyjs.org/%EF%BC%89%E3%80%82">https://www.gatsbyjs.org/）。</a></p>
</li>
<li><p>  nuxt.js：服务器端渲染 Vue 组件框架（参考查看：<a target="_blank" rel="noopener" href="https://nuxtjs.org/%EF%BC%89">https://nuxtjs.org/）</a>, Vue 采用 vue-server-renderer 调用 renderToString() 方法。</p>
</li>
</ul>
<p>协作方式：</p>
<ul>
<li><p>  后端专注于业务功能实现和 API 接口封装。</p>
</li>
<li><p>  前端负责实现页面前端交互，根据后端 API 接口拼装前端模板，页面渲染，以及服务器维护。</p>
</li>
</ul>
<p>选型建议：</p>
<ul>
<li><p>  前端要处理 Node server 的机器环境、代码部署、日志、容灾、监控等以往后端人员需要具备运维知识，前端人员的综合能力要求会比以往要高。</p>
</li>
<li><p>  前端项目开发周期变长了，需要事先和产品、运营沟通排期问题。</p>
</li>
</ul>
<h2 id="PWA-技术方案和实现思路"><a href="#PWA-技术方案和实现思路" class="headerlink" title="PWA 技术方案和实现思路"></a>PWA 技术方案和实现思路</h2><p>Progressive Web App，简称 PWA，PWA 应用是使用特定技术和标准模式来开发的 Web 应用，这将同时赋予它们 Web 应用和原生应用的特性。</p>
<p>技术优势：</p>
<ul>
<li><p>  用户可以用手机屏幕启动应用，即使在离线状态或者弱网下，通过事先缓存的资源，也可正常加载运行当前应用，可以完全消除对网络的依赖，从而给用户非常可靠的体验。</p>
</li>
<li><p>  因为预先缓存了资源，部分资源无须经过网络，即秒开页面。</p>
</li>
<li><p>  和移动设备上的原生应用一样，具有沉浸式的用户体验。</p>
</li>
<li><p>  可以给用户发送离线推送消息。</p>
</li>
</ul>
<p>技术实现：</p>
<ul>
<li><p>  全站改造成 HTTPS，没有 HTTPS 就没有 Service Worker。</p>
</li>
<li><p>  应用 Service Worker 技术提升性能，离线提供静态资源文件，提升首屏用户体验。</p>
</li>
<li><p>  使用 App Manifest。</p>
</li>
<li><p>  最后可以考虑离线消息推送等功能。</p>
</li>
</ul>
<p>浏览器兼容性：</p>
<ul>
<li><p>  ServiceWorkerGlobalScope API：88%</p>
</li>
<li><p>  Web App Manifest 83%</p>
</li>
</ul>
<h2 id="页面加载策略优化"><a href="#页面加载策略优化" class="headerlink" title="页面加载策略优化"></a>页面加载策略优化</h2><ul>
<li><p>  懒加载</p>
</li>
<li><p>  预加载</p>
</li>
<li><p>  预渲染</p>
</li>
<li><p>  按需加载</p>
</li>
</ul>
<p>下面具体展开讲讲。</p>
<h3 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h3><p>懒加载也叫延迟加载，指的是长网页中延迟加载特定元素（可以是图片，也可以是 JS/CSS 文件，当然也可以是 JavaScript 的特定函数和方法，以下简称“懒加载元素”）。</p>
<p>好处：可以减少当前屏无效资源的加载。</p>
<p>技术实现举例：把页面上“懒加载元素”src 属性设置为空字符，把真实的 src 属性写在 data-lazy 属性中，当页面滚动的时候监听 scroll 事件，如果“懒加载元素”在可视区域内，就把图片的 src 属性或者文件 URL 路径设置成 data-lazy 属性值。</p>
<h3 id="预加载"><a href="#预加载" class="headerlink" title="预加载"></a>预加载</h3><p>可以使用预加载让浏览器来预先加载某些资源（比如图片、JS/CSS/模板），而这些资源是在将来才会被使用到的。简单来说，就是将所需资源提前加载到浏览器本地，这样后面在需要使用的时候就可以直接从浏览器缓存中取了，而不用再重新开始加载。</p>
<p>使用场景：如果你希望这个资源能尽快显示给用户，就可以使用预加载。</p>
<p>好处：减少用户后续加载资源等待的时间。</p>
<p><strong>技术实现举例</strong>：</p>
<ol>
<li>HTML 标签：</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://xxx.jpg&quot;</span> <span class="attr">style</span>=<span class="string">&quot;display: none&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、使用 Image 对象：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> image = <span class="keyword">new</span> Image();</span><br><span class="line"></span><br><span class="line">image.src = <span class="string">&#x27;https://xxx.jpg&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>3、使用 preload、prefetch 和 preconnect：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">“preload”</span> <span class="attr">href</span>=<span class="string">“src/style.css”</span> <span class="attr">as</span>=<span class="string">“style”</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;scr/image.png&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;dns-prefetch&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://my.com&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;preconnect&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://my.com&quot;</span> <span class="attr">crossorigin</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="预渲染"><a href="#预渲染" class="headerlink" title="预渲染"></a>预渲染</h3><p>有一种预加载组件的方式就是提前渲染它。在页面中渲染组件，但是并不在页面中展示。也就是渲染完成后，先隐藏起来，用的时候再展示。</p>
<p>实现举例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;prerender&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://my.com&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="按需加载"><a href="#按需加载" class="headerlink" title="按需加载"></a>按需加载</h3><ul>
<li><p>  常规按需加载（如 JS 原生、jQuery）</p>
</li>
<li><p>  不同 App 按需加载（如 JS-SDK 脚本文件）</p>
</li>
<li><p>  不同设备按需加载（如 PC 端和 HTML5 端样式文件）</p>
</li>
<li><p>  不同分辨率按需加载（CSS Media Query）</p>
</li>
</ul>
<p>React 异步加载举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> componentA = <span class="function">(<span class="params">location, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>.ensure(</span><br><span class="line">        [],</span><br><span class="line">        <span class="function">(<span class="params"><span class="built_in">require</span></span>) =&gt;</span> &#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="built_in">require</span>(<span class="string">&#x27;modules/componentA&#x27;</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;componentA&#x27;</span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> componentB = <span class="function">(<span class="params">location, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>.ensure(</span><br><span class="line">        [],</span><br><span class="line">        <span class="function">(<span class="params"><span class="built_in">require</span></span>) =&gt;</span> &#123;</span><br><span class="line">            callback(<span class="literal">null</span>, <span class="built_in">require</span>(<span class="string">&#x27;modules/componentB&#x27;</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;componentB&#x27;</span></span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">Router</span> <span class="attr">history</span>=<span class="string">&#123;history&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">component</span>=<span class="string">&#123;App&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;componentA&quot;</span> <span class="attr">getComponent</span>=<span class="string">&#123;componentA&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;componentB&quot;</span> <span class="attr">getComponent</span>=<span class="string">&#123;componentB&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<p>Vue 异步加载举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(VueRouter);</span><br><span class="line"><span class="keyword">const</span> componentA = <span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">require</span>([<span class="string">&#x27;src/a.vue&#x27;</span> ], resolve);</span><br><span class="line"><span class="keyword">const</span> componentB = <span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">require</span>([<span class="string">&#x27;src/b.vue&#x27;</span> ], resolve);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">    <span class="attr">routes</span>: [&#123;<span class="attr">path</span>:<span class="string">&quot;a”,name:&quot;</span>/a”,<span class="attr">component</span>:componentA&#125;,</span><br><span class="line">     &#123;<span class="attr">path</span>:<span class="string">&quot;b”,name:&quot;</span>/b”,<span class="attr">component</span>:componentB&#125;]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">    <span class="attr">router</span>: router,</span><br><span class="line">    <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="接口服务调用优化"><a href="#接口服务调用优化" class="headerlink" title="接口服务调用优化"></a>接口服务调用优化</h2><p>1、接口合并：一个页面的众多业务接口和依赖的第三方接口，合并为一个部署在集群的接口统一调用，以减少页面接口请求数。</p>
<p>2、接口上 CDN：主要基于接口性能考虑，我们可以把<strong>不需要实时更新的接口同步至 CDN</strong>，等此接口内容变更之后自动同步至 CDN 集群上。如果一定时间内未请求到数据，会用源站接口再次请求。</p>
<p>3、接口域名上 CDN：增强可用性、稳定性。</p>
<p>4、接口降级：核心接口进行降级用基础接口进行业务实现，比如千人千面的推荐接口，在大促时间点可以直接运营编辑的数据。另外如果接口无访问，建议使用兜底数据。</p>
<p>5、接口监控：监控接口成功率，不只是常说的 TP99，也包括弱网、超时、网络异常、网络切换等一段情况的监控情况。排查出来问题后，需要联合后端、运维、网络岗位人员一并解决。</p>
<h2 id="接口缓存策略优化"><a href="#接口缓存策略优化" class="headerlink" title="接口缓存策略优化"></a>接口缓存策略优化</h2><p>1、Ajax/fetch 缓存：前端请求时候带上 cache，依赖浏览器本身缓存机制。</p>
<p>2、本地缓存：异步接口数据优先使用本地 localStorage 中的缓存数据。</p>
<p>3、多次请求：接口数据本地无 localStorage 缓存数据，重新再次发出 ajax 请求。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/04-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/04-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">04-静态资源优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:52" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:52+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="图片格式和应用场景"><a href="#图片格式和应用场景" class="headerlink" title="图片格式和应用场景"></a>图片格式和应用场景</h2><h3 id="JPEG-格式"><a href="#JPEG-格式" class="headerlink" title="JPEG 格式"></a>JPEG 格式</h3><p>JPEG（Joint Photographic Experts Group）是一种针对彩色照片而广泛使用的有损压缩图形格式，属于位图。</p>
<p>常用文件扩展名为<code>.jpg</code>，也有 <code>.jpeg</code>和<code>.jpe</code>。JPEG 在互联网上常被应用于存储和传输照片。</p>
<ul>
<li><p>适合：颜色丰富的照片、彩色图大焦点图、通栏 banner 图；结构不规则的图形。</p>
</li>
<li><p>不适合：线条图形和文字、图标图形，因为它的压缩算法不太这些类型的图形；并且不支持透明度。</p>
</li>
</ul>
<h3 id="PNG-格式"><a href="#PNG-格式" class="headerlink" title="PNG 格式"></a>PNG 格式</h3><p>PNG（Portable Network Graphics）是一种无损压缩的位图图形格式，支持索引、灰度、RGB 三种颜色方案以及 Alpha 通道等特性。</p>
<p>PNG 最初是作为替代 GIF 来设计的，能够显示 256 色，文件比 JPEG 或者 GIF 大，但是 PNG 非常好的保留了图像质量。支持 Alpha 通道的半透明和透明特性。最高支持 24 位彩色图像（PNG-24）和 8 位灰度图像（PNG-8）。</p>
<ul>
<li><p>适合：纯色、<strong>透明</strong>、线条绘图，图标；边缘清晰、有大块相同颜色区域；需要带<strong>半透明</strong>的图片。</p>
</li>
<li><p>适合：由于是无损存储，所以不太适合体积太大的彩色图像</p>
</li>
</ul>
<p>比如说，如果你需要带透明背景的图片，此时就可以用 png 格式的图。</p>
<h3 id="GIF-格式"><a href="#GIF-格式" class="headerlink" title="GIF 格式"></a>GIF 格式</h3><p>GIF（Graphics Interchange Format）是一种位图图形格式，以 8 位色（即 256 种颜色）重现真彩色的图像，采用 LZW 压缩算法进行编码。</p>
<p>支持 256 色；仅支持完全透明和完全不透明；如果需要带动画效果的图片，GIF 是比较通用的选择。</p>
<ul>
<li><p>适合：动画，图标。</p>
</li>
<li><p>不适合：每个像素只有 8 比特，不适合存储彩色图片。</p>
</li>
</ul>
<h3 id="Webp-格式"><a href="#Webp-格式" class="headerlink" title="Webp 格式"></a>Webp 格式</h3><p>Webp 是一种现代图像格式，可为图像提供无损压缩和有损压缩，这使得它非常灵活。由 Google 在购买 On2 Technologies 后发展出来，以 BSD 授权条款发布。</p>
<p>Webp的优秀算法能同时保证图像质量和较小体积；可以插入多帧，实现动画效果；可以设置透明度；采用 8 位压缩算法。</p>
<p>无损的 Webp 比 PNG 小 26%，有损的 Webp 比 JPEG 小 25-34％，比 GIF 有更好的动画。</p>
<ul>
<li>适合：适用于图形和半透明图像。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>banner图、大图，可以用 jpg、webp格式。</p>
</li>
<li><p>图标、带透明背景的图，可以用 png 格式。</p>
</li>
<li><p>带动画效果的图，可以用 gif 格式。</p>
</li>
</ul>
<h2 id="图片优化的常见方法"><a href="#图片优化的常见方法" class="headerlink" title="图片优化的常见方法"></a>图片优化的常见方法</h2><h3 id="1、用工具压缩图片"><a href="#1、用工具压缩图片" class="headerlink" title="1、用工具压缩图片"></a>1、用工具压缩图片</h3><p><strong>压缩 PNG 图片</strong>：</p>
<ul>
<li><p>工具：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/node-pngquant-native">node-pngquant-native</a></p>
</li>
<li><p>介绍：跨平台、压缩比特别高，压缩png24非常好。</p>
</li>
</ul>
<p>安装方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install node-pngquant-native</span><br></pre></td></tr></table></figure>

<p><strong>压缩 JPEG 图片</strong>：</p>
<ul>
<li><p>工具：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jpegtran">jpegtran</a></p>
</li>
<li><p>官网：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jpegtran">https://www.npmjs.com/package/jpegtran</a></p>
</li>
<li><p>介绍：跨平台，但压缩的比率只有80-90%。</p>
</li>
</ul>
<p>安装方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install –g jpegtran</span><br></pre></td></tr></table></figure>

<p>使用方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jpegtran -copy none -optimize -outfile output_file.jpg input_file.jpg</span><br></pre></td></tr></table></figure>

<p><strong>压缩 GIF 图</strong>：</p>
<ul>
<li><p>工具：Gifsicle</p>
</li>
<li><p>官网（含安装方法）：<a target="_blank" rel="noopener" href="https://www.lcdf.org/gifsicle/">https://www.lcdf.org/gifsicle/</a></p>
</li>
<li><p>介绍：Gifsicle 通过改变每帧比例，减小 gif文件大小，同时可以使用透明来达到更小的文件大小，是目前公认的最好的解决方案。</p>
</li>
</ul>
<p>使用方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 压缩命令。注意，这里是将压缩级别设置为3。如果将压缩级别设置为1或者2，则基本不压缩。</span></span><br><span class="line">gifsicle --optimize=3 -o out_file.gif in_file.gif</span><br><span class="line"></span><br><span class="line"><span class="comment"># 裁掉透明部分</span></span><br><span class="line">gifsicle --optimize=3 --crop-transparency -o out_file.gif in_file.gif</span><br></pre></td></tr></table></figure>

<h3 id="2、将图片尺寸跟随网络环境进行变化"><a href="#2、将图片尺寸跟随网络环境进行变化" class="headerlink" title="2、将图片尺寸跟随网络环境进行变化"></a>2、将图片尺寸跟随网络环境进行变化</h3><p><strong>具体方案</strong>：不同网络环境（Wifi/4G/3G）下，加载不同尺寸和像素的图片，通过在图片 URL 中添加参数来改变。</p>
<p>图片 url 举例1：（图片的原始url链接）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://img12.360buyimg.com/img/s3866x3866_jfs/t1/149913/14/18648/719436/5fd8b9b5Eb697b825/7c23f3028aff8e2b.jpg</span><br></pre></td></tr></table></figure>

<p>图片 url 举例2：（通过图片的url参数，将这张图的尺寸设置为200px）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://img12.360buyimg.com/img/s200x200_jfs/t1/149913/14/18648/719436/5fd8b9b5Eb697b825/7c23f3028aff8e2b.jpg</span><br></pre></td></tr></table></figure>

<h3 id="3、响应式图片"><a href="#3、响应式图片" class="headerlink" title="3、响应式图片"></a>3、响应式图片</h3><p><strong>方法1</strong>：通过 JavaScript 绑定事件，检测窗口大小，以此设置图片大小。</p>
<p><strong>方法2</strong>：CSS媒体查询。</p>
<p>代码举例：（在 640px的窗口大小里，设置图片的尺寸为640px）</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>:<span class="number">640px</span>) &#123;</span><br><span class="line">  my_image&#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">640px</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>方法3</strong>：img标签的 <code>srcset</code> 属性。这个是 H5的新特性。</p>
<p>代码举例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">srcset</span>=<span class="string">&quot;img-320w.jpg, img-640w.jpg 2x, img-960w.jpg 3x&quot;</span> <span class="attr">src</span>=<span class="string">“img-960w.jpg”</span></span></span><br><span class="line"><span class="tag"><span class="attr">alt</span>=<span class="string">“img”</span>&gt;</span> （x 描述符：表示图像的设备像素）</span><br></pre></td></tr></table></figure>

<h3 id="4、逐步加载图像：lazyload、LQIP、LQIP"><a href="#4、逐步加载图像：lazyload、LQIP、LQIP" class="headerlink" title="4、逐步加载图像：lazyload、LQIP、LQIP"></a>4、逐步加载图像：lazyload、LQIP、LQIP</h3><p><strong>方法1</strong>、使用统一占位符。俗称图片的<code>懒加载（lazyload）</code>。</p>
<p><strong>方法2</strong>、使用 <strong>LQIP</strong> 的图片加载方式。也就是说，在大图没有完全加载出来的情况下，先这张图对应的的低质量图片进行占位。</p>
<p>LQIP（Low Quality Image Placeholders）：低质量图像占位符。这种技术背后的想法是，在网络环境较差的情况下，你可以尽快向用户展示完全可用的网页，为他们提供更好的体验。即使在更好的网络连接上，这仍然为用户提供了更快的可用页面，并且改善了体验。</p>
<ul>
<li><p>安装 LQIP 工具：<code>npm install lqip</code></p>
</li>
<li><p>GitHub源码：<a target="_blank" rel="noopener" href="https://github.com/zouhir/lqip-loader">https://github.com/zouhir/lqip-loader</a></p>
</li>
</ul>
<p>代码举例：（将目标图片转换为 LQIP 形式的图）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> lqip = <span class="built_in">require</span>(<span class="string">&#x27;lqip&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//文件路径</span></span><br><span class="line"><span class="keyword">const</span> file = <span class="string">&#x27;./in.png&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将输入的图片转为base64</span></span><br><span class="line">lqip.base64(file).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 色值</span></span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">lqip.palette(file).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//这里输出的是base64的图片地址</span></span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>另外，我们还可以使用 <strong>SQIP</strong> 的图片加载方式。</p>
<p>SQIP（SVG Quality Image Placeholders）： SVG 格式的图像占位符。</p>
<ul>
<li><p>安装  SQIP 工具：<code>npm install sqip</code></p>
</li>
<li><p>GitHub 源码：<a target="_blank" rel="noopener" href="https://github.com/axe312ger/sqip">https://github.com/axe312ger/sqip</a></p>
</li>
</ul>
<p>代码举例：（将目标图片转换为 SQIP 形式的图）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sqip = <span class="built_in">require</span>(<span class="string">&#x27;sqip&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result =  sqip(&#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;./input_file.png&#x27;</span>,</span><br><span class="line">    <span class="attr">numberOfPrimitives</span>: <span class="number">10</span> <span class="comment">//可根据不同应用场景设置大小</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(result.final_svg);</span><br></pre></td></tr></table></figure>

<h3 id="5、雪碧图（Image-spriting）"><a href="#5、雪碧图（Image-spriting）" class="headerlink" title="5、雪碧图（Image spriting）"></a>5、雪碧图（Image spriting）</h3><p>雪碧图是比较常见的图片优化方式，也就是把多张小图合并成一张大图。这样的话，就只需做一次网络请求，减少图片的 http 请求次数。</p>
<p>读者们可以自行查阅。</p>
<h3 id="6、有些场景下，并不需要图片文件"><a href="#6、有些场景下，并不需要图片文件" class="headerlink" title="6、有些场景下，并不需要图片文件"></a>6、有些场景下，并不需要图片文件</h3><p>有些场景下，并不需要图片，我们可以用其他的方式来代替图片。</p>
<p>举例：</p>
<ul>
<li><p>Web Font 代替图片</p>
</li>
<li><p>使用 Data URI 代替图片。base64就是属于 Data URI的方式。</p>
</li>
</ul>
<h3 id="7、在服务器端进行图片自动优化"><a href="#7、在服务器端进行图片自动优化" class="headerlink" title="7、在服务器端进行图片自动优化"></a>7、在服务器端进行图片自动优化</h3><p>图片服务器自动化优化是可以在图片 URL 链接上增加不同特殊参数，服务器自动化生成。通过这些参数，可以设置图片的不同格式、大小、质量。</p>
<p><strong>常见处理方式</strong>：</p>
<ul>
<li><p>图片裁剪：按长边、短边、填充、拉伸等缩放。</p>
</li>
<li><p>图片格式转换：支持 JPG，GIF，PNG，WebP 等，支持不同的图片压缩率。</p>
</li>
<li><p>图片处理：添加图片水印、高斯模糊、重心处理、裁剪边框等。</p>
</li>
<li><p>AI 能力：鉴黄、涉政、智能抠图、智能排版、智能配色、智能合成等 AI 功能。</p>
</li>
</ul>
<p><strong>图片举例</strong>：</p>
<p>比如JD公司的图片链接，就会在服务器端做优化处理。通过修改图片链接中的参数，就能自动达到相应的优化效果。</p>
<p>原始图片链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://img12.360buyimg.com/img/s3866x3866_jfs/t1/149913/14/18648/719436/5fd8b9b5Eb697b825/7c23f3028aff8e2b.jpg</span><br></pre></td></tr></table></figure>

<p>将图片压缩为 200*150：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://img12.360buyimg.com/img/s200x200_jfs/t1/149913/14/18648/719436/5fd8b9b5Eb697b825/7c23f3028aff8e2b.jpg</span><br></pre></td></tr></table></figure>

<p>将图片转换为 webp 格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://img12.360buyimg.com/img/s200x200_jfs/t1/149913/14/18648/719436/5fd8b9b5Eb697b825/7c23f3028aff8e2b.webp</span><br></pre></td></tr></table></figure>

<p>将图片质量压缩至10%：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://img12.360buyimg.com/img/s3866x3866_jfs/t1/149913/14/18648/719436/5fd8b9b5Eb697b825/7c23f3028aff8e2b.jpg.q10</span><br></pre></td></tr></table></figure>


<h2 id="HTML优化"><a href="#HTML优化" class="headerlink" title="HTML优化"></a>HTML优化</h2><h3 id="1、精简-HTML-代码"><a href="#1、精简-HTML-代码" class="headerlink" title="1、精简 HTML 代码"></a>1、精简 HTML 代码</h3><ul>
<li><p>减少 HTML 的嵌套。</p>
</li>
<li><p>减少 DOM 节点数。</p>
</li>
<li><p>减少无语义代码（比如: <div class=“clear”></div> 消除浮动，其实可以用css来处理）。</p>
</li>
<li><p>删除 http 或者 https：如果URL的协议头和当前页面的协议头一致的，或者此 URL 在多个协议头都是可用的，则可以考虑删除协议头。</p>
</li>
<li><p>删除多余的空格、换行符、缩进和不必要的注释。</p>
</li>
<li><p>省略冗余标签和属性。</p>
</li>
<li><p>使用相对路径的 URL。</p>
</li>
</ul>
<h3 id="2、文件放在合适位置"><a href="#2、文件放在合适位置" class="headerlink" title="2、文件放在合适位置"></a>2、文件放在合适位置</h3><ul>
<li>CSS 样式文件链接尽量放在页面头部。</li>
</ul>
<p>CSS 加载不会阻塞 DOM tree 解析，但是会阻塞 DOM Tree 渲染，也会阻塞后面 JS 执行。</p>
<p>任何 body 元素之前，可以确保在文档部分中解析了所有 CSS 样式（内联和外联），从而减少了浏览器必须重排文档的次数。</p>
<p>如果放置页面底部，就要等待最后一个 CSS 文件下载完成，此时会出现”白屏”，影响用户体验。</p>
<ul>
<li>JS 引用放在 HTML 底部</li>
</ul>
<p>防止 JS 在加载、解析、执行时，阻塞了页面后续元素的正常渲染。</p>
<h3 id="4、增强用户体验"><a href="#4、增强用户体验" class="headerlink" title="4、增强用户体验"></a>4、增强用户体验</h3><ul>
<li>设置 favicon.ico</li>
</ul>
<p>网站如果不设置 favicon.ico，控制台会报错。另外页面加载过程中如果没有图标，则会出现 loading 过程，也不利于记忆网站品牌，建议统一添加。</p>
<ul>
<li>增加首屏必要的 CSS 和 JS</li>
</ul>
<p>页面如果需要等待所的依赖的 JS 和 CSS 加载完成才显示，则在渲染过程中页面会一直显示空白，影响用户体验，建议在首屏增加必要的 CSS 和 JS，比如页面框架背景图片或者loading 图标，内联在 HTML 页面中。这样做，首屏能快速显示出来，缓解用户焦虑。现在很多网页在初始化的时候，流行做<strong>骨架屏</strong>，小伙伴们也可以研究下。</p>
<h2 id="CSS优化"><a href="#CSS优化" class="headerlink" title="CSS优化"></a>CSS优化</h2><h3 id="1、提升-CSS-渲染性能"><a href="#1、提升-CSS-渲染性能" class="headerlink" title="1、提升 CSS 渲染性能"></a>1、提升 CSS 渲染性能</h3><ul>
<li><p>谨慎使用 expensive 属性，这类属性比较耗浏览器的性能。比如：<code>nth-child</code> 伪类；<code>position: fixed</code> 定位。</p>
</li>
<li><p>尽量减少样式的层级数。</p>
</li>
</ul>
<p>比如：<code>div ul li span i &#123;color: blue;&#125;</code>这样的层级就太深了。建议给 i 标签设置 class属性，然后通过class直接设置样式属性，可以提升浏览器的查询效率。</p>
<ul>
<li><p>尽量避免使用占用过多 CPU 和内存的属性。比如：<code>text-indnt:-99999px</code>。</p>
</li>
<li><p>尽量少使用耗电量大的属性。比如：CSS3 3D transforms、CSS3 transitions、Opacity 这样的属性会消耗GPU。</p>
</li>
</ul>
<h3 id="2、合适使用-CSS-选择器"><a href="#2、合适使用-CSS-选择器" class="headerlink" title="2、合适使用 CSS 选择器"></a>2、合适使用 CSS 选择器</h3><ul>
<li>尽量避免使用 CSS 表达式。</li>
</ul>
<p>比如 <code>background-color: expression( (new Date()).getHours()%2 ? &quot;#FFF&quot; : &quot;#000&quot; );</code>这个属性的意思是，每间隔两小时，改变白景色。</p>
<ul>
<li>尽量避免使用通配选择器。</li>
</ul>
<p>比如 <code>body &gt; a &#123;font-weight:blod;&#125;</code>这样的属性，可能会把 body 里所有的标签遍历一遍，才找到 a 标签，比较耗时。</p>
<ul>
<li>尽量避免类正则的属性选择器：<code>*=， |=， ^=， $=</code></li>
</ul>
<h3 id="3、提升-CSS-文件加载性能"><a href="#3、提升-CSS-文件加载性能" class="headerlink" title="3、提升 CSS 文件加载性能"></a>3、提升 CSS 文件加载性能</h3><ul>
<li>使用外链的 CSS。</li>
</ul>
<p>我们知道，内联的 css 是在html 内部写的。相比之下，外链的 CSS文件是放在CDN上的，可以缓存，既能减少 html 页面的体积大小，也能利用缓存减少资源的请求。</p>
<ul>
<li>尽量避免使用 @import 方法</li>
</ul>
<p>整个CSS加载完成后，浏览器会把 import 中所有依赖的文件全部加载完成后，浏览器才会接着往下渲染。这个过程会阻塞CSS文件的加载过程。</p>
<h3 id="4、精简-CSS-代码"><a href="#4、精简-CSS-代码" class="headerlink" title="4、精简 CSS 代码"></a>4、精简 CSS 代码</h3><ul>
<li><p>使用缩写语句</p>
</li>
<li><p>删除不必要的零。比如 0.2 可以写成 .2</p>
</li>
<li><p>删除不必要的单位，比如 0px 可以写成 0</p>
</li>
<li><p>删除过多的空格；注释言简意赅</p>
</li>
<li><p>尽量减少样式表的大小</p>
</li>
</ul>
<p>当然，很多地方可以在编译时，通过压缩工具来处理；但是我们在写代码时，也应该有良好的编码习惯。</p>
<h3 id="5、合理使用-Web-Fonts"><a href="#5、合理使用-Web-Fonts" class="headerlink" title="5、合理使用 Web Fonts"></a>5、合理使用 Web Fonts</h3><ul>
<li><p>将字体文件部署在 CDN 上。</p>
</li>
<li><p>或者将字体以 base64 形式保存在 CSS 中并通过 localStorage 进行缓存</p>
</li>
<li><p>Google 字体库因为某些不可抗拒原因，应该使用国内托管服务</p>
</li>
</ul>
<h3 id="6、CSS-动画优化"><a href="#6、CSS-动画优化" class="headerlink" title="6、CSS 动画优化"></a>6、CSS 动画优化</h3><ul>
<li><p>尽量避免同时出现过多动画。</p>
</li>
<li><p>延迟动画初始化：让其他的重要的CSS样式优先渲染。</p>
</li>
<li><p>结合 SVG。</p>
</li>
</ul>
<h2 id="JavaScript-总体优化"><a href="#JavaScript-总体优化" class="headerlink" title="JavaScript 总体优化"></a>JavaScript 总体优化</h2><h3 id="提升-JavaScript-文件加载性能"><a href="#提升-JavaScript-文件加载性能" class="headerlink" title="提升 JavaScript 文件加载性能"></a>提升 JavaScript 文件加载性能</h3><p>加载元素的顺序 CSS 文件放在 <head> 里， JavaScript 文件放在 <body> 里。</p>
<h3 id="JavaScript-变量和函数优化"><a href="#JavaScript-变量和函数优化" class="headerlink" title="JavaScript 变量和函数优化"></a>JavaScript 变量和函数优化</h3><ul>
<li><p>尽量使用 id 选择器</p>
</li>
<li><p>尽量避免使用 eval</p>
</li>
<li><p>JavaScript 函数尽可能保持简洁</p>
</li>
<li><p>使用事件节流函数</p>
</li>
<li><p>使用事件委托</p>
</li>
</ul>
<h3 id="JavaScript-动画优化"><a href="#JavaScript-动画优化" class="headerlink" title="JavaScript 动画优化"></a>JavaScript 动画优化</h3><ul>
<li><p>避免添加大量 JavaScript 动画</p>
</li>
<li><p>尽量使用 CSS3 动画</p>
</li>
<li><p>尽量使用 Canvas 动画</p>
</li>
<li><p>合理使用 requestAnimationFrame 动画代替 setTimeout、setInterval</p>
</li>
<li><p>requestAnimationFrame可以在正确的时间进行渲染，setTimeout（callback）和setInterval（callback）无法保证 callback 回调函数的执行时机。</p>
</li>
</ul>
<h3 id="合理使用缓存"><a href="#合理使用缓存" class="headerlink" title="合理使用缓存"></a>合理使用缓存</h3><ul>
<li><p>合理缓存 DOM 对象</p>
</li>
<li><p>缓存列表长度</p>
</li>
<li><p>使用可缓存的 Ajax</p>
</li>
</ul>
<h2 id="JavaScript-缓存优化"><a href="#JavaScript-缓存优化" class="headerlink" title="JavaScript 缓存优化"></a>JavaScript 缓存优化</h2><h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>通常由浏览器存储，然后将 Cookie 与每个后续请求一起发送到同一服务器。收到HTTP 请求时，服务器可以发送带有 Cookie 的 header 头。可以给 Cookie 设置有效时间。</p>
<p>应用：</p>
<ul>
<li><p>会话管理：登录名，购物车商品，游戏得分或服务器应要记录的其他任何内容</p>
</li>
<li><p>个性化：用户首选项，主题或其他设置</p>
</li>
<li><p>跟踪：记录和分析用户行为，比如visitkey</p>
</li>
</ul>
<h3 id="sessionStorage"><a href="#sessionStorage" class="headerlink" title="sessionStorage"></a>sessionStorage</h3><p>创建一个本地存储的键/值对。</p>
<p>应用：</p>
<ul>
<li><p>缓存。</p>
</li>
<li><p>页面应用页面之间传值。</p>
</li>
</ul>
<h3 id="LocalStorage"><a href="#LocalStorage" class="headerlink" title="LocalStorage"></a>LocalStorage</h3><p>本地存储。</p>
<p>应用于：</p>
<ul>
<li><p>缓存静态文件内容 JavaScript /CSS（比如百度M站首页）</p>
</li>
<li><p>缓存不常变更的 API 接口数据</p>
</li>
<li><p>储存地理位置信息</p>
</li>
<li><p>浏览在页面的具体位置</p>
</li>
</ul>
<h3 id="IndexedDB"><a href="#IndexedDB" class="headerlink" title="IndexedDB"></a>IndexedDB</h3><p>索引数据库。</p>
<p>应用：</p>
<ul>
<li><p>客户端存储大量结构化数据</p>
</li>
<li><p>没有网络连接的情况下使用（比如 Google Doc、石墨文档）</p>
</li>
<li><p>将冗余、很少修改、但经常访问的数据，以避免随时从服务器获取数据</p>
</li>
</ul>
<h2 id="JavaScript-模块化加载方案和选型"><a href="#JavaScript-模块化加载方案和选型" class="headerlink" title="JavaScript 模块化加载方案和选型"></a>JavaScript 模块化加载方案和选型</h2><ul>
<li>CommonJS</li>
</ul>
<p>旨在 Web 浏览器之外为 JavaScript 建立模块生态系统。Node.js 模块化方案受 CommonJS。</p>
<ul>
<li>AMD (Asynchronous Module Definition)（异步模块定义）规范。</li>
</ul>
<p>RequireJS 模块化加载器：基于 AMD API 实现。</p>
<ul>
<li>CMD（ Common Module Definition）（通用模块定义）规范。</li>
</ul>
<p>SeaJS 模块化加载器：遵循 CMD API 编写。</p>
<ul>
<li>ES6 import。</li>
</ul>
<h2 id="减少回流和重绘重要举措"><a href="#减少回流和重绘重要举措" class="headerlink" title="减少回流和重绘重要举措"></a>减少回流和重绘重要举措</h2><h3 id="CSS"><a href="#CSS" class="headerlink" title="CSS"></a>CSS</h3><ul>
<li><p>避免过多样式嵌套</p>
</li>
<li><p>避免使用 CSS 表达式</p>
</li>
<li><p>使用绝对定位，可以让动画元素脱离文档流</p>
</li>
<li><p>避免使用 table 布局</p>
</li>
<li><p>尽量不使用 float 布局</p>
</li>
<li><p>图片最好设置好 width 和 height</p>
</li>
<li><p>尽量简化浏览器不必要的任务，减少页面重新布局</p>
</li>
<li><p>使用 Viewport 设置屏幕缩放级别</p>
</li>
<li><p>避免频繁设置样式，最好把新 style 属性设置完成后，进行一次性更改</p>
</li>
<li><p>避免使用引起回流/重绘的属性，最好把相应变量缓存起来</p>
</li>
</ul>
<h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h3><ul>
<li><p>最小化回流和重排：为了减少回流发生次数，避免频繁或操作 DOM，可以合并多次对 DOM 修改，然后一次性批量处理。</p>
</li>
<li><p>控制绘制过程和绘制区域：绘制过程开销比较大的属性设置应该尽量避免减少使用；同时，减少绘制区域范围。</p>
</li>
</ul>
<h2 id="DOM-编程优化的⽅式方法"><a href="#DOM-编程优化的⽅式方法" class="headerlink" title="DOM 编程优化的⽅式方法"></a>DOM 编程优化的⽅式方法</h2><h3 id="控制-DOM-大小"><a href="#控制-DOM-大小" class="headerlink" title="控制 DOM 大小"></a>控制 DOM 大小</h3><p>众所周知，页面交互卡顿和流畅度很大一部分原因就是页面有大量 DOM 元素。想象一下，从一个上万节点的 DOM 树上，使用 querySelectorAll 或 getElementByTagName 方法查找某一个节点，是非常耗时的。另外元素绑定事件，事件冒泡和事件捕获的执行也会相对耗时。</p>
<p>通常控制 DOM 大小的技巧包括：</p>
<ul>
<li><p>合理的业务逻辑</p>
</li>
<li><p>延迟加载即将呈现的内容</p>
</li>
</ul>
<h3 id="简化-DOM-操作"><a href="#简化-DOM-操作" class="headerlink" title="简化 DOM 操作"></a>简化 DOM 操作</h3><p>对DOM节点的操作统一处理后，再统一插入到 DOM Tree中。</p>
<p>可以使用 fragment，尽量不在页面 DOM Tree 里直接操作。</p>
<p>现在流行的框架 Angular、React、Vue 都在使用虚拟 DOM 技术，通过 diff 算法简化和减少 DOM 操作。</p>
<h2 id="静态文件压缩工具介绍"><a href="#静态文件压缩工具介绍" class="headerlink" title="静态文件压缩工具介绍"></a>静态文件压缩工具介绍</h2><p>HTML 压缩工具：</p>
<ul>
<li>html-minifier：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/html-minifier">https://www.npmjs.com/package/html-minifier</a></li>
</ul>
<p>CSS 压缩工具：</p>
<ul>
<li>clean-css：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/clean-css">https://www.npmjs.com/package/clean-css</a></li>
</ul>
<p>JavaScript 压缩工具：</p>
<ul>
<li><p>uglify-js：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/uglify-js">https://www.npmjs.com/package/uglify-js</a></p>
</li>
<li><p>使用方法：uglifyjs in.js -o out.js</p>
</li>
</ul>
<h2 id="静态⽂文件打包⽅方案"><a href="#静态⽂文件打包⽅方案" class="headerlink" title="静态⽂文件打包⽅方案"></a>静态⽂文件打包⽅方案</h2><ul>
<li><p>公共组件拆分</p>
</li>
<li><p>压缩： JavaScript /CSS/图片</p>
</li>
<li><p>合并： JavaScript /CSS 文件合并，CSS Sprite</p>
</li>
<li><p>Combo： JavaScript /CSS 文件</p>
</li>
</ul>
<h2 id="静态⽂文件版本号更新策略"><a href="#静态⽂文件版本号更新策略" class="headerlink" title="静态⽂文件版本号更新策略"></a>静态⽂文件版本号更新策略</h2><p>缓存更新：CDN 或 ng 后台刷新文件路径，更新文件header头。</p>
<p>文件 name.v1-v100.js：</p>
<ul>
<li><p>大功能迭代每次新增一个大版本，比如由 v1 到 v2</p>
</li>
<li><p>小功能迭代新增加 0.0.1 或者 0.1.0，比如从 v1.0.0 至 v1.0.1</p>
</li>
<li><p>年末 ng 统一配置所有版本 302 至最新版</p>
</li>
</ul>
<p>时间戳.文件 name.js：以每次上线时间点做差异。</p>
<p>hash.文件。以文件内容 hash 值做 key。</p>
<h2 id="前端构建工具介绍和选型建议"><a href="#前端构建工具介绍和选型建议" class="headerlink" title="前端构建工具介绍和选型建议"></a>前端构建工具介绍和选型建议</h2><h3 id="常用构建工具"><a href="#常用构建工具" class="headerlink" title="常用构建工具"></a>常用构建工具</h3><ul>
<li><p>Gulp：通过流（Stream）来简化多个任务间的配置和输出，配置代码相对较少。</p>
</li>
<li><p>Webpack：预编译，中间文件在内存中处理，支持多种模块化，配置相对很简单。</p>
</li>
<li><p>FIS</p>
</li>
</ul>
<h3 id="webpack-打包优化"><a href="#webpack-打包优化" class="headerlink" title="webpack 打包优化"></a>webpack 打包优化</h3><ul>
<li><p>定位体积大的模块</p>
</li>
<li><p>删除没有使用的依赖</p>
</li>
<li><p>生产模式进行公共依赖包抽离</p>
</li>
<li><p>开发模式进行 DLL &amp; DllReference 方式优化</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/03-%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/03-%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">03-渲染优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:52" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:52+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="浏览器的渲染机制"><a href="#浏览器的渲染机制" class="headerlink" title="浏览器的渲染机制"></a>浏览器的渲染机制</h2><p>我们需要先理解浏览器的渲染经历了哪些过程，才能有针对性的进行相关优化。</p>
<p>掌握浏览器的渲染优化，可以说是前端工程师的一个分水岭。如果想要具备架构师的思维，需要达到什么样的能力？不光是要解决当下的问题，还需要掌握基本的原理，将来在遇到新问题时也能解决，即“预测问题”。</p>
<p>有一个经典的面试题是：“在浏览器的地址栏输入url，回车后，经历了哪些过程？”这个问题并不简单，根据你回答的详细程度，可以看出你对前后端知识的掌握程度。你能否答出“浏览器的渲染机制”？如果不能，说明你对浏览器渲染的性能优化，不够了解。</p>
<p>关于浏览器的渲染机制，可以看本教程的另外一篇文章：</p>
<blockquote>
<p>《前端面试/面试必看/浏览器渲染机制.md》</p>
</blockquote>
<p>关键渲染路径举例：</p>
<p><img src="images/image-20210323184157879.png" alt="image-20210323184157879"></p>
<p><img src="images/image-20210323184551245.png" alt="image-20210323184551245"></p>
<h2 id="避免布局抖动（layout-thrashing）"><a href="#避免布局抖动（layout-thrashing）" class="headerlink" title="避免布局抖动（layout thrashing）"></a>避免布局抖动（layout thrashing）</h2><p>1、尽量避免 重排：</p>
<p>比如说，如果想改变一个元素的位置，很多人可能会使用相对布局的left、top属性，但是这个属性会引起重排。我们可以使用 <code>transfrom:translate</code>让元素做位移，这个属性既不会触发重排，也不会触发 重绘，只会触发 conmposite。</p>
<p>再比如说，vue、react这样的框架，采用了虚拟DOM，它会把涉及到DOM修改的操作积攒起来，然后统一计算，批量处理，最后应用到真正的DOM上。</p>
<p>2、读写分离。建议先批量读（获取位置等信息），然后再批量做写操作（修改位置）。</p>
<p>补充：</p>
<p>如果你的页面经常需要做重排、重绘，就很容易导致“页面抖动”。</p>
<p>很多时候，我们知道原理和解决方案。但是在工程化实践的时候，往往时间很紧，没有时间去做这些事情。我们希望有一些拿来就可以用的、而且经过测试没有问题的工具，来帮我们解决问题。</p>
<p>FastDom是用于做防抖的一个比较流行的解决方案。</p>
<h2 id="减少重绘（repaint）"><a href="#减少重绘（repaint）" class="headerlink" title="减少重绘（repaint）"></a>减少重绘（repaint）</h2><h2 id="防抖（Debounce）：降低事件的触发频率"><a href="#防抖（Debounce）：降低事件的触发频率" class="headerlink" title="防抖（Debounce）：降低事件的触发频率"></a>防抖（Debounce）：降低事件的触发频率</h2><p>我们可以针对<strong>高频事件</strong>做防抖。</p>
<p><strong>高频事件处理函数</strong>：有很多事件的触发频率非常高，甚至超过了屏幕的刷新率（60帧/秒）。比如页面滚动、鼠标移动、移动端的touch事件。</p>
<p>如果我们不对这些事件做处理，就会频繁导致浏览器做重排、重绘，影响性能，导致页面卡顿，也就是“抖动”。因此需要对这些高频事件处理函数做防抖处理，降低它们的触发频率。</p>
<p>比如说滚动事件：我其实并不关心滚动中间的过程，我只关心最终滚动到了哪里。</p>
<p>requestAnimationFrame 这个api可以做防抖。</p>
<p>参考文章：</p>
<ul>
<li>防抖与节流：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6885250789825052679">https://juejin.cn/post/6885250789825052679</a></li>
</ul>
<h2 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h2><h3 id="JS的开销"><a href="#JS的开销" class="headerlink" title="JS的开销"></a>JS的开销</h3><p>静态资源有很多种：js、图片、css、字体等。这些资源都有可能会很大，但是JS的开销仍然是最昂贵的，因为JS除了加载资源之外，还需要经历<strong>解析&amp;编译</strong>、<strong>执行的</strong>过程。</p>
<h3 id="如何缩短JS的解析事件"><a href="#如何缩短JS的解析事件" class="headerlink" title="如何缩短JS的解析事件"></a>如何缩短JS的解析事件</h3><h3 id="Web-loading-is-a-Journey"><a href="#Web-loading-is-a-Journey" class="headerlink" title="Web loading is a Journey"></a>Web loading is a Journey</h3><p><img src="images/1*vSGOCrLV9MiLhpmPid1CHQ.png" alt="img"></p>
<h3 id="V8引擎"><a href="#V8引擎" class="headerlink" title="V8引擎"></a>V8引擎</h3><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><ul>
<li>首屏尽快打开，剩下的内容延迟加载，减少初次加载的资源量。首屏的内容是可以确定的。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02-%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02-%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">02-浏览器渲染机制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:52" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:52+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>渲染机制</strong>包括的内容：</p>
<ul>
<li><p>什么是DOCTYPE及作用</p>
</li>
<li><p>浏览器渲染过程。面试经常会问：在浏览器中输入url，发生了哪些事情。其中有一部就是浏览器的渲染过程。</p>
</li>
<li><p>Reflow：重排。面试官问完了渲染机制，一般会紧接着问重排Reflow，你可千万别说你没听过。</p>
</li>
<li><p>Repaint：重绘</p>
</li>
<li><p>Layout：布局。这里的Layout指的是浏览器的Layout。</p>
</li>
</ul>
<h2 id="什么是DOCTYPE及作用"><a href="#什么是DOCTYPE及作用" class="headerlink" title="什么是DOCTYPE及作用"></a>什么是DOCTYPE及作用</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p><strong>DTD</strong>（Document Type Definition）：文档类型定义。</p>
<p>是一系列的语法规则，用来定义XML或者(X)HTML文件类型。<strong>浏览器会使用DTD来判断文本类型</strong>，决定使用何种协议来解析，以及切换浏览器模式。（说白了就是：DTD就是告诉浏览器，我是什么文档类型，你要用什么协议来解析我）</p>
<p><strong>DOCTYPE</strong>：用来声明DTD规范。</p>
<p>一个主要的用途便是文件的合法性验证。如果文件代码不合法，那么浏览器解析时便会出现一些差错。（说白了，DOCTYPE就是用来声明DTD的）</p>
<h3 id="常见的DOCTYPE声明有几种"><a href="#常见的DOCTYPE声明有几种" class="headerlink" title="常见的DOCTYPE声明有几种"></a>常见的DOCTYPE声明有几种</h3><blockquote>
<p>面试官紧接着会问，常见的 DOCTYPE 有哪些，以及 HTML5 的 DOCTYPE 怎么写。</p>
</blockquote>
<p>1、<strong>HTML 4.01 Strict</strong>：（严格的）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//W3C//DTD HTML 4.01//EN&quot;</span> <span class="meta-string">&quot;http://www.w3.org/TR/html4/strict.dtd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>PS：该DTD包含所有的HTML元素和属性，但不包括展示性的和弃用的元素（比如 font、u下划线等，这些是被废弃了的）。</p>
<p>2、<strong>HTML 4.01 Transitional</strong>：（传统的）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="meta-string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>PS：该DTD包含所有的HTML元素和属性，但包括展示性的和弃用的元素（比如 font、u下划线等）。</p>
<p>3、HTML 5：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p><strong>总结：</strong></p>
<p>面试时，不会让你写出 HTML 4.01的写法，因为大家都记不住。但是要记住 HTML 5 的写法，别看它简单，知道的人还真不多。</p>
<p>面试时，可以这样回答： HTML 4.01 中有两种写法，一种是严格的，一种是传统的；并且答出二者的区别。 HTML 5的写法是<code>&lt;!DOCTYPE html&gt;</code>。</p>
<h2 id="浏览器的渲染过程"><a href="#浏览器的渲染过程" class="headerlink" title="浏览器的渲染过程"></a>浏览器的渲染过程</h2><h3 id="渲染树"><a href="#渲染树" class="headerlink" title="渲染树"></a>渲染树</h3><p><img src="http://img.smyhvae.com/20210118-2005.png"></p>
<blockquote>
<p>上方图片的来源：<a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction?hl=zh-cn">Google 官方 | 渲染树构建、布局及绘制</a></p>
</blockquote>
<p><strong>渲染树</strong>包含了网页中有哪些节点、节点的从属关系、以及节点的CSS样式（大小、颜色等）。</p>
<p>浏览器下载完html文档之后，第一步是先将其解析成文本。而html标签是由一对一对的尖括号表述的，可以被浏览器解析为有含义的标记。这些标记被翻译成节点对象，存放到链型数据结构中。这些节点被称之为<strong>DOM对象</strong>，这个链型数据结构就是<strong>渲染树</strong>。</p>
<h3 id="渲染过程（重要）"><a href="#渲染过程（重要）" class="headerlink" title="渲染过程（重要）"></a>渲染过程（重要）</h3><p>浏览器的渲染过程非常复杂，面试时找重点说就行，不然太耗时间。如何快速简洁地描述清楚，是关键。来看看下面这张图。</p>
<p><img src="http://img.smyhvae.com/20180310_1257.png"></p>
<p>渲染过程中，涉及到以下几个概念：</p>
<ul>
<li><p>DOM树（DOM Tree）：浏览器将HTML标签解析成树形的数据结构。DOM树包含了有哪些节点，以及节点之间的从属关系（嵌套关系）。</p>
</li>
<li><p>CSSOM（CSS Rule Tree）：浏览器将CSS解析成树形的数据结构。CSSOM包含了节点的CSS样式（大小、颜色等）。</p>
</li>
<li><p>渲染树（Render Tree）: DOM 树与 CSSOM 树<strong>合并</strong>后形成渲染树。渲染树只包含渲染网页所需的节点（但并不知道位置）。</p>
</li>
<li><p>布局（Layout）: 计算出每个节点在屏幕中的<strong>位置和大小</strong>。</p>
</li>
<li><p>绘制（Painting）：按照算出来的规则，通过显卡，把内容画出来。</p>
</li>
<li><p>composite：合成。浏览器在绘制的时候，一开始不会把所有的内容都画在同一层上。需要把这些内容画在不同的曾上，最终合并到一起，并显示在屏幕上。</p>
</li>
</ul>
<p>参考链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/slly/p/6640761.html">浏览器渲染原理及流程</a></li>
</ul>
<h3 id="关键渲染路径"><a href="#关键渲染路径" class="headerlink" title="关键渲染路径"></a>关键渲染路径</h3><p>说到渲染，就不得不提到“关键渲染路径”，它描述的是渲染从触发到绘制的过程。浏览器渲染经历了五个阶段：</p>
<blockquote>
<p>JavaScript/CSS –&gt; Style –&gt; Layout –&gt; Paint –&gt; Composite</p>
</blockquote>
<p><img src="http://img.smyhvae.com/20210118-1950.jpg"></p>
<blockquote>
<p>上方图片的来源：<a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/performance/rendering">https://developers.google.com/web/fundamentals/performance/rendering</a></p>
</blockquote>
<p>关键渲染路径描述的是渲染从触发到绘制的全过程，一共经历了五个阶段：</p>
<p>（1）<strong>触发视觉的变化：</strong>通过JS、CSS代码来<strong>触发</strong>页面上的视觉变化。比如通过 jQuery添加节点、通过CSS添加动画，都可以触发视觉上的变化。</p>
<p>（2）Style：浏览器对样式进行计算。匹配选择器，计算哪些CSS受到了影响。</p>
<p>（3）layout：同上一段。</p>
<p>（4）painting：同上一段。</p>
<p>（5）conmposite：同上一段。</p>
<p>理论上，上面的五个步骤都是必须要经历的。布局和绘制是关键渲染路径中，最重要、开销最高的两个步骤。</p>
<p>但是，有些样式并不会影响布局，也不会影响绘制。所以，浏览器对这方面的性能进行了优化，并不一定要经历布局和绘制这两个过程。这就需要我们先了解一下「重排」和「重绘」这两个概念。详见下一段。</p>
<h2 id="布局-回流-重排"><a href="#布局-回流-重排" class="headerlink" title="布局/回流/重排"></a>布局/回流/重排</h2><h3 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h3><p>布局 layout：</p>
<p>渲染对象在创建完成并添加到渲染树时，是将DOM节点和它对应的样式结合起来，并不包含位置和大小信息。</p>
<p>我们还需要通过 <code>Layout</code> 布局阶段，来计算它们在设备视口(viewport)内的确切位置和大小，计算这些值的过程称为<code>回流</code>、<code>布局</code>或<code>重排（Reflow）</code>。</p>
<p>参考链接：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiahj/p/11777786.html">从浏览器渲染原理，浅谈回流重绘与性能优化</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/chenjigeng/blog/issues/4">你真的了解回流和重绘吗</a></p>
</li>
</ul>
<h3 id="什么时候会触发布局"><a href="#什么时候会触发布局" class="headerlink" title="什么时候会触发布局"></a>什么时候会触发布局</h3><p>DOM元素的<strong>大小</strong>和<strong>位置</strong>发生变化的时候，会触发布局。</p>
<ul>
<li><p>增加、删除DOM元素</p>
</li>
<li><p>display: none</p>
</li>
<li><p>移动元素位置，或是增加动画</p>
</li>
<li><p>修改CSS样式时（宽高、display 为none等，都是通过css样式来修改的）</p>
</li>
<li><p>offsetLeft、scrollTop、clientWidth</p>
</li>
<li><p>修改浏览器窗口大小时（即Resize窗口，移动端没有这个问题），或是滚动的时候，<strong>有可能</strong>会触发（具体要看浏览器的规则）。</p>
</li>
<li><p>修改网页的默认字体时（这个很消耗性能）。</p>
</li>
</ul>
<p><strong>面试总结：</strong></p>
<p>首先要答出 Reflow 定义；其次，什么时候触发，至少要答出两条。更进一步，面试官可能还会问你<strong>怎么避免reflow</strong>，这个可以自己去查查。</p>
<h2 id="绘制-重绘"><a href="#绘制-重绘" class="headerlink" title="绘制/重绘"></a>绘制/重绘</h2><h3 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h3><p><strong>绘制 paint</strong>：当各种盒子的位置、大小以及其他属性，例如颜色、字体大小等都确定下来后，浏览器便把这些元素都按照各自的特性绘制一遍，于是页面的内容出现了，这个过程也称之为 Repaint（重绘制）。</p>
<p>说白了，页面要呈现的内容，统统画在屏幕上，这就叫 Repaint。</p>
<h3 id="什么时候触发绘制"><a href="#什么时候触发绘制" class="headerlink" title="什么时候触发绘制"></a>什么时候触发绘制</h3><ul>
<li><p>DOM改动</p>
</li>
<li><p>CSS改动</p>
</li>
</ul>
<p>其实，就是判断当视觉上是否发生变化（无论这个变化是通过DOM改动还是CSS改动）。只要页面显示的内容不一样了，肯定要 Repaint。</p>
<p><strong>面试总结：</strong></p>
<p>面试官经常会问：“如何<strong>尽量减少</strong>Repaint的频率？”</p>
<p>注意， reflow是问“怎么避免”，repaint是问“怎么减少”。Repaint是无法避免的，否则就成了静态页面了。</p>
<p><strong>答案</strong>：</p>
<p>（1）如果需要创建多个DOM节点，可以使用<strong>DocumentFragment</strong>创建完，然后一次性地加入document。（加一个节点，就repaint一次，不太好）</p>
<p>（2）将元素的display设置为”none”，完成修改后再把display修改为原来的值。</p>
<p>参考链接：<a target="_blank" rel="noopener" href="http://blog.csdn.net/liaozhongping/article/details/47057889">如何减少浏览器repaint和reflow ?</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/01-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E5%92%8C%E6%8C%87%E6%A0%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/01-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E5%92%8C%E6%8C%87%E6%A0%87/" class="post-title-link" itemprop="url">01-前端性能分析工具和指标</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:52" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:52+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="性能指标和优化目标之：加载"><a href="#性能指标和优化目标之：加载" class="headerlink" title="性能指标和优化目标之：加载"></a>性能指标和优化目标之：加载</h2><p>性能指标：我们在性能优化过程中可以参考的标准。这些标准都是业界或者前人总结出来的指导性经验。我们可以参考这些指标，去指导我们自己的优化。</p>
<h3 id="打开网站的初体验"><a href="#打开网站的初体验" class="headerlink" title="打开网站的初体验"></a>打开网站的初体验</h3><p>我们以淘宝网站为例，按下F12打开浏览器的调试模式。</p>
<p><img src="http://img.smyhvae.com/20210115_1601.png"></p>
<p>上图中，鼠标右键点击“刷新”图标（或者鼠标长按刷新图标，松开鼠标后），会弹出三个选项，我们选择最后一个选项“清空缓存并硬性重新加载”。</p>
<p>补充：这三个选项都是在调试模式下（按下F12弹出调试面板）才会出现的。</p>
<p>浏览器的DevTools初印象：</p>
<p><img src="https://img.smyhvae.com/20210115_1617.png"></p>
<p>上图中，打开 chrome 调试工具，点开「设置」icon，下面的四个选项中，除了“Group by frame”之外，其他的三个选项都可以勾选上。</p>
<p>我们可以看到淘宝网站的一些指标：</p>
<ul>
<li>总资源量是 1.3M。</li>
<li>DOM加载完成时间（DOMContentLoaded）：511ms。这是一个很关键的指标。</li>
<li>其他资源的总加载时间是 1.05秒。</li>
</ul>
<p>我们再来对比一下京东的：</p>
<p><img src="http://img.smyhvae.com/20210116-1357.png"></p>
<h3 id="保存快照"><a href="#保存快照" class="headerlink" title="保存快照"></a>保存快照</h3><p>network里的信息挺多，我们可以将其保存下来，留着以后做分析、做对照。</p>
<p><img src="http://img.smyhvae.com/20210115-1723.png"></p>
<p>如上图所示，我们可以在 network 的空白处右键，选择“Save all as HAR with content”，将 network 信息保存为 <strong>HAR</strong>文件格式。</p>
<p><strong>HAR是一种标准的Web格式，用户保存性能测试的结果。里面的数据是json格式。</strong></p>
<p>我们可以使用第三方的 HAR 分析软件来打开 HAR 文件，比如：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://toolbox.googleapps.com/apps/har_analyzer/?lang=zh-CN">Google 提供的 HAR 分析器</a></p>
</li>
<li><p>Fiddler 抓包工具</p>
</li>
</ul>
<p>注意，HAR 文件包含了一些敏感信息：</p>
<p><img src="http://img.smyhvae.com/20210115-1733.png"></p>
<h3 id="瀑布图-Waterfall"><a href="#瀑布图-Waterfall" class="headerlink" title="瀑布图 Waterfall"></a>瀑布图 Waterfall</h3><p><img src="http://img.smyhvae.com/20210115_1618.png"></p>
<p>瀑布图可以非常直观地把网站的加载过程，用自上而下的方式表达出来，就像瀑布一样。</p>
<p>瀑布图有两中解读方式：一种是横向看，一种是纵向看。</p>
<p><strong>1、横向看</strong>：</p>
<p>横向看的是具体的资源，每一行代表某个资源的加载信息。里面有一些色块来表达加载的过程，每个块的颜色不同。也就是说资源的下载不是单一的过程，而是经历了很多环节。</p>
<p>为了了解资源的具体加载过程，我们把鼠标悬浮在第一个资源的色块上，可以看见一个详情列表：</p>
<p><img src="http://img.smyhvae.com/20210115_1632.png"></p>
<p>（1）等待：</p>
<ul>
<li>Queueing：排队。浏览器会对资源的请求做优先级排序。</li>
</ul>
<p>（2）连接：</p>
<ul>
<li><p>DNS Lookup：DNS域名解析。每个资源都有域名，对域名做DNS解析，然后找到对应服务器的IP地址。</p>
</li>
<li><p>initial connection：客户端和服务器之间建立TCP连接。</p>
</li>
<li><p>SSL证书：该网站为了保证安全性，使用了 https 协议，启用了SSL证书。启用之后，需要做安全认证（SSL协商），这个过程也会耗时。到这里位置，我们可以看到，在请求资源之前，有很多的前置步骤。</p>
</li>
</ul>
<p>（3）请求和响应：</p>
<ul>
<li><p>Request sent：到这一步，真正开始请求资源。</p>
</li>
<li><p>Waiting（<strong>TTFB</strong>）：资源从请求到响应，有一个等待的时间。</p>
</li>
<li><p>Content Download：收到响应后，资源的下载时间。如果值越大，表明下载时间越长。有些同步加载的资源会造成阻塞，导致网页的整体加载时间过长，让用户等待太久。</p>
</li>
</ul>
<p><strong>TTFB</strong> 是一个很重要的指标，它表示的是：请求发出到响应，到底要经历多久。TTFB 可以给我们一个很直观的感受，我们网站的请求和响应到底是快还是慢，很大程度上是由 TTFB 决定。</p>
<p>影响 TTFB 的因素是什么呢？比如：</p>
<ul>
<li><p>后台的处理能力的响应速度。</p>
</li>
<li><p>网络状况：是否有网络延迟。</p>
</li>
</ul>
<p><strong>2、纵向看</strong>：（主要看两点）</p>
<p>（1）看资源与资源之间的联系：如果发生阻塞，说明资源可能是串行地按顺序加载。可以<strong>按需要适当调整为并行</strong>。</p>
<p>（2）看关键的时间节点。Waterfall 中有<strong>两根时间线</strong>：蓝色的线是 DOM 加载完成的时间，红色的线是所有资源加载完成的时间。</p>
<h2 id="性能指标和优化目标之：交互"><a href="#性能指标和优化目标之：交互" class="headerlink" title="性能指标和优化目标之：交互"></a>性能指标和优化目标之：交互</h2><p>上面的内容讲的是<strong>加载</strong>的性能，还有一个需要关注的性能指标是<strong>交互</strong>。也就是网站加载完成后，用户真正开始使用这个网站过程中的的交互体验。</p>
<p>关于交互体验的性能，我们需要关注的是：</p>
<ul>
<li><p>交互动作的<strong>响应时间</strong>要短：比如点击按钮后的弹窗、在搜索框里输入关键字后的搜索结果。</p>
</li>
<li><p>页面滚动要流畅：可以查看 FPS 帧率。</p>
</li>
<li><p>异步请求接口的完成时间要短：比如关注/取关主播的响应、领取红包的操作。</p>
</li>
</ul>
<h3 id="FPS帧率、FRS"><a href="#FPS帧率、FRS" class="headerlink" title="FPS帧率、FRS"></a>FPS帧率、FRS</h3><p>这里首先科普两个概念：</p>
<ul>
<li>刷新率：显示器每秒有多少帧画面。大多数显示器的刷新率是60帧/秒（即60hz）。</li>
<li>帧率（FPS：frames per second）：视频或者动画的内容本身，每秒有多少帧。由显卡输出帧率。</li>
</ul>
<p>上面的两个参数中，不要把「刷新率」和「帧率」弄混了。「刷新率」是屏幕的参数，「帧率」是图像、视频等内容的参数。人眼最终看到的效果，是以最低的参数为准的。</p>
<p>目前，市场主流手机和电脑屏幕的刷新率基本都是60Hz，即每秒显示60帧画面。也就是说，当我们在使用手机的时候，本质上是手机在连续播放一张张静态图片，每秒播放60张，让肉眼误认为眼前的画面在动。</p>
<p><img src="http://img.smyhvae.com/20210107_2115.gif"></p>
<p>持续滑动的过程中，如果页面输出到显示器的帧率低于60帧/秒，则人眼会感觉卡顿。</p>
<p>那么，在浏览器中如何实时显示内容的 FPS 参数呢？打开浏览器的控制台后，按住快捷键「Cmd + Shift + P」，然后输入 <code>frame</code>，选择<code>Show frames per second（FPS） meter</code>。如下：</p>
<p><img src="http://img.smyhvae.com/20210115-1930.png"></p>
<p><img src="http://img.smyhvae.com/20210115-2146.png"></p>
<p><strong>温馨提示</strong>：</p>
<p>从 2020年7月起，chrome 官方已经取消了 fps参数的显示，改为了 <a target="_blank" rel="noopener" href="https://twitter.com/addyosmani/status/1281483292026400768">FRS</a>：</p>
<p><img src="http://img.smyhvae.com/20210115-2006.png"></p>
<p>FRS参数观察的是丢帧率：</p>
<p><img src="http://img.smyhvae.com/20210115-2010.png"></p>
<p>Chrome官方给我们提供了下面这个网站，用于观察 FPS 效果：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://googlesamples.github.io/web-fundamentals/tools/chrome-devtools/rendering-tools/forcedsync.html">http://googlesamples.github.io/web-fundamentals/tools/chrome-devtools/rendering-tools/forcedsync.html</a></li>
</ul>
<p>如果实在想要看fps，我们可以借助第三方的 <a href="">chrome 插件</a>来查看 fps参数。</p>
<h2 id="用-RAIL-模型测量性能"><a href="#用-RAIL-模型测量性能" class="headerlink" title="用 RAIL 模型测量性能"></a>用 RAIL 模型测量性能</h2><p>RAIL 模型是Google提出的可以量化性能的测量<strong>标准</strong>。我们做性能优化时，要尽可能到这个标准。</p>
<p>在做性能优化的时候，我们需要有人告诉我们：做到多好才算好？有没有一些通用的标准？而 RAIL 模型 可以给我们带来量化的指标。</p>
<p><strong>RAIL 模型包括四个方面</strong>：</p>
<p><img src="http://img.smyhvae.com/20210115-2027.png"></p>
<ul>
<li><p>Response：响应</p>
</li>
<li><p>Animation：动画</p>
</li>
<li><p>Idle：空闲时间</p>
</li>
<li><p>load：加载</p>
</li>
</ul>
<p>参考链接：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6872474167543857165">[Web翻译]用RAIL模型测量性能</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://web.dev/rail/">https://web.dev/rail/</a></p>
</li>
</ul>
<p><strong>RAIL 的目标</strong>：</p>
<ul>
<li>让良好的用户体验成为性能优化的目标</li>
</ul>
<p>接下来，我们再看看看 RAIL 的评估标准。</p>
<h3 id="1、响应"><a href="#1、响应" class="headerlink" title="1、响应"></a>1、响应</h3><p><strong>目标</strong>：处理用户发起的响应，应该在 50ms 内完成。</p>
<p><strong>准则</strong>：</p>
<ul>
<li><p>在50毫秒内处理用户输入事件。这适用于大多数输入，如点击按钮、切换表单控件或启动动画。这不适用于触摸拖动或滚动。</p>
</li>
<li><p>对于需要超过50毫秒才能完成的操作，需要提供反馈。</p>
</li>
</ul>
<p><img src="http://img.smyhvae.com/20210115-2039.png"></p>
<p>如上图所示，Google经过大量研究发现，用户能够接受的最高延时是100ms。所以，从用户发起交互请求（输入任务）后，前端最好能在100ms内给出反馈。</p>
<p><strong>但是我们的预算只有50毫秒</strong>。因为应用程序在接收到输入任务的时候，不一定会马上着手处理，它可能还有其他工作正在进行，这意味着当前的输入任务可能需要排队50ms左右。所以我们真正能处理这个请求的时间，并没有100ms。</p>
<h3 id="2、动画"><a href="#2、动画" class="headerlink" title="2、动画"></a>2、动画</h3><p><strong>目标</strong>：在10毫秒或更短的时间内制作出动画中的每一帧。（即：100帧/秒。）</p>
<p>我们知道，当动画的帧率是 &gt;= 60帧/秒 的时候，人眼才不会觉得卡顿。此时的理论值为 1000毫秒/60帧 = 16.6 毫秒/帧。</p>
<p>10毫秒和16毫秒之间，隔了6秒。这6秒是什么呢？因为浏览器需要大约6毫秒的时间来渲染每一帧，所以，每一帧的准则建议是10毫秒，而不是 16.6毫秒。</p>
<p>假设动画本身是60帧/秒，那么，最终渲染出来的效果可能只有 45帧/秒。</p>
<p><strong>广义的动画</strong>：</p>
<p>动画不仅仅是花哨的UI效果。每一种交互都被认为是动画。比如：</p>
<ul>
<li><p>视觉动画</p>
</li>
<li><p>滚动</p>
</li>
<li><p>拖动、平移元素、放大图片等。</p>
</li>
</ul>
<h3 id="3、空闲时间"><a href="#3、空闲时间" class="headerlink" title="3、空闲时间"></a>3、空闲时间</h3><p><strong>目标</strong>：最大化闲置时间，增加页面在50毫秒内响应用户输入的几率。</p>
<p>这个空闲时间，是和上面的第一点“响应”是结合在一起的。只有空闲足够多，当用户的交互来的时候，我们才能有足够的时间进行处理。</p>
<p><strong>准则</strong>：</p>
<ul>
<li><p>利用空闲时间做延迟加载。例如，页面在初始化的时候，尽可能少的加载数据，然后利用空闲时间加载其余部分。</p>
</li>
<li><p>在空闲时间内处理任务，时间不能超过50毫秒。否则，就阻塞了用户做其他的输入请求，导致卡顿。</p>
</li>
<li><p>如果用户在闲置时间工作期间与页面进行交互，那么这个交互应始终处于最高优先级，并中断闲置时间工作。</p>
</li>
</ul>
<h3 id="4、加载"><a href="#4、加载" class="headerlink" title="4、加载"></a>4、加载</h3><p><strong>目标</strong>：在5秒或更短的时间内加载页面并可以交互。</p>
<p><strong>准则</strong>：</p>
<ul>
<li><p>这里的5秒包括：加载、解析、渲染，并确保用户可以交互。</p>
</li>
<li><p>加载的过程中，可以使用loading框、进度条、骨架屏等方式缓解用户焦虑。</p>
</li>
</ul>
<h2 id="使用Chrome-DevTools-分析性能"><a href="#使用Chrome-DevTools-分析性能" class="headerlink" title="使用Chrome DevTools 分析性能"></a>使用Chrome DevTools 分析性能</h2><p>现在主流的性能测量工具：</p>
<ul>
<li><p>Chrome DevTools：开发调试、分析性能。</p>
</li>
<li><p>Lighthouse 网站整体质量评估。</p>
</li>
<li><p>WebPageTest：给网站提供多个地点的测试，以及全面的性能报告。</p>
</li>
</ul>
<p>这一段，我们先来讲一讲 Chrome DevTools 。</p>
<p>大家平时在用 Chrome DevTools 的时候，一般使用来开发调试、查看 DOM、css、接口请求等，但其实，这个工具非常强大。</p>
<h3 id="size：文件大小分析"><a href="#size：文件大小分析" class="headerlink" title="size：文件大小分析"></a>size：文件大小分析</h3><p><img src="http://img.smyhvae.com/20210116-0946.png"></p>
<p>可以把size从到小排序，看看哪个资源的文件较大。</p>
<p>另外，上图中的横线处说明：该文件在网络传输的时候会做压缩（125kb），拿到资源之后再解压还原（526kb）。</p>
<h3 id="performance：性能表现"><a href="#performance：性能表现" class="headerlink" title="performance：性能表现"></a>performance：性能表现</h3><p><img src="http://img.smyhvae.com/20210116-0959.png"></p>
<p>preformance的两个作用：</p>
<ul>
<li>Record button：记录页面加载、用户交互等全过程，直到我们手动点击停止按钮。</li>
<li>Reload button：记录页面从刷新到资源加载完成的过程。会自动停止记录。</li>
</ul>
<p>参数解读：</p>
<ul>
<li><p>Timing：关键的时间节点。</p>
</li>
<li><p>Main：主线程做了哪些任务，以及调用关系。</p>
</li>
</ul>
<p>Timing参数中，尤其注意看<code>DCL</code>（DOMContentLoaded），即DOM加载完成的时间节点。我们可以通过<code>Main</code>参数看看DOM在加载完成之前，都做了些什么事情。很有可能就是这些事情导致 <code>DCL</code>的时间过晚。</p>
<p>我们可以翻到<code>Main</code>里的最后一行（即最终调用的位置），往往这个位置就是我们自己写的代码。</p>
<h3 id="Diable-cache"><a href="#Diable-cache" class="headerlink" title="Diable cache"></a>Diable cache</h3><p><img src="http://img.smyhvae.com/20210116-1014.png"></p>
<p>上图中的<code>Diable cache</code>是一个很重要的设置选项。</p>
<p>勾选<code>Diable cache</code>：</p>
<ul>
<li>不走缓存，相当于页面初次访问。</li>
<li>如果你希望改的代码立即生效，就一定要勾选上。</li>
</ul>
<p>不勾选<code>Diable cache</code>：</p>
<ul>
<li>走缓存，相当于页面二次、三次访问。</li>
<li>很多时候，我们需要关心用户在第二次、第三次访问时候，他的访问速度如何、性能如何、我们设置的缓存有没有生效。此时就不要勾选上。</li>
</ul>
<h3 id="模拟网络情况"><a href="#模拟网络情况" class="headerlink" title="模拟网络情况"></a>模拟网络情况</h3><p><img src="http://img.smyhvae.com/20210116-1023.png"></p>
<p>模拟网络状况（自定义参数）：</p>
<p><img src="http://img.smyhvae.com/20210116-1026.png"></p>
<h3 id="Performance-monitor"><a href="#Performance-monitor" class="headerlink" title="Performance monitor"></a>Performance monitor</h3><p><img src="http://img.smyhvae.com/20210116-1032.png"></p>
<h3 id="快捷键ESC"><a href="#快捷键ESC" class="headerlink" title="快捷键ESC"></a>快捷键ESC</h3><p>按住快捷键ESC，会列出其他常用的功能菜单：</p>
<p><img src="http://img.smyhvae.com/20210116-1028.png"></p>
<h2 id="使用LightHouse分析性能"><a href="#使用LightHouse分析性能" class="headerlink" title="使用LightHouse分析性能"></a>使用LightHouse分析性能</h2><p>我们之所以使用不同的性能测量工具，是因为他们都有不同的特点。这一段要讲的 lighthouse 既可以帮我们生成简易的测试报告，还可以给出一些针对性的优化建议。后面要讲的 WebPageTest 可以帮我们生成详细的性能测试报告。</p>
<p>我们先来看看 Lighthouse。</p>
<h3 id="Lighthouse-介绍"><a href="#Lighthouse-介绍" class="headerlink" title="Lighthouse 介绍"></a>Lighthouse 介绍</h3><p><img src="http://img.smyhvae.com/20210115-1739.png"></p>
<p>lighthouse 是 chrome 浏览器的一个性能测量工具。我们先来看看它的性能指标，至于它具体使用，后续的内容再详细介绍。</p>
<p>淘宝跑分举例：</p>
<p><img src="http://img.smyhvae.com/20210115-1758.png"></p>
<p>京东跑分举例：</p>
<p><img src="http://img.smyhvae.com/20210115-1759.png"></p>
<p>Lighthouse 跑分里，最重要的两个指标如下：</p>
<ul>
<li><p><strong>First Contentful Paint（白屏时间）</strong>：<strong>从白屏到第一次出现内容的时间。</strong>我们可以看到，上面提供了一些加载过程的截图，10屏里如果只有1到2屏是白屏，说明体验还是可以的。</p>
</li>
<li><p><strong>Speed Index</strong>：速度指数。</p>
</li>
</ul>
<p>我们不需要关心这个指数是怎么来的，因为背后涉及一套很复杂的公式，我们暂时只需关注这个数值。</p>
<p>Speed Index 标准为4秒（超过4秒算比较慢的），我们测的淘宝的 speed index 是0.5s，很快了。但我们要结合网站本身的业务来<strong>权衡</strong>。并不是分数越高性能越高，比如百度这样的网站，页面上的内容很少，测出来的分数肯定很完美。而淘宝需要展示很多内容给用户看。所以，这个指标只是一个指导作用，并不一定能够达到最优的数值。</p>
<p>Lighthouse 的分析结果里，也给出了颜色标注：</p>
<ul>
<li>红色：比较严重的性能问题</li>
<li>黄色：需要做适当优化</li>
<li>绿色：说明性能表现很好。</li>
</ul>
<p>另外，Lighthouse  还会给出一些优化建议：</p>
<ul>
<li><p>Opportunities:优化建议。</p>
</li>
<li><p>Diagnostics：问题诊断。</p>
</li>
<li><p>Passed audits：表示这部分没有问题。</p>
</li>
</ul>
<h3 id="举例：确认某个JS-是否必须在首屏加载"><a href="#举例：确认某个JS-是否必须在首屏加载" class="headerlink" title="举例：确认某个JS 是否必须在首屏加载"></a>举例：确认某个JS 是否必须在首屏加载</h3><p>就拿B站来举例，来看看它的lighthouse报告：</p>
<p><img src="http://img.smyhvae.com/20210116_0107.png"></p>
<p>上图中给出了一个优化建议：有些JS文件不是首屏加载必须的。</p>
<p><img src="http://img.smyhvae.com/20210116_0108.png"></p>
<p>我们随便拿一个JS文件来测试（比如上图中，Header标签里的JS文件）。做法如下：</p>
<p><img src="http://img.smyhvae.com/20210116-0901.png"></p>
<p>如上图所示，在 chrome 控制台输入快捷键「Cmd + Shift + P」，然后输入文本<code>block</code>，选择<code>Show Network request blocking</code>：</p>
<p><img src="http://img.smyhvae.com/20210116-0903.png"></p>
<p>按照上面的步骤添加规则，点击add后，效果如下：</p>
<p><img src="http://img.smyhvae.com/20210116-0904.png"></p>
<p>然后，我们切换到控制台的 network面板，并刷新页面：</p>
<p><img src="http://img.smyhvae.com/20210116-0905.png"></p>
<p>然后观察这个js资源是不是首屏加载所必须的。但我们也不能就此定论说这个资源一定可以延迟加载，也许它就是想让页面在一开始loading的时候就捕获日志。</p>
<p>对于我们自己的网站，这个资源是首屏加载必须的吗？一定要在第一时间加载吗？需要根据特定的业务做衡量。</p>
<h3 id="通过npm运行-Lighthouse工具"><a href="#通过npm运行-Lighthouse工具" class="headerlink" title="通过npm运行 Lighthouse工具"></a>通过npm运行 Lighthouse工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">npm install -g lighthouse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">lighthouse https://www.jd.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出性能检测报告</span></span><br><span class="line">Generating results...</span><br><span class="line">html output witten to /Users/smyh/Documents/wpt-mac-agent/www.jd.com._2021-01-16_09-00-00.html</span><br></pre></td></tr></table></figure>






<h2 id="使用-WebPageTest-评估网站性能"><a href="#使用-WebPageTest-评估网站性能" class="headerlink" title="使用 WebPageTest 评估网站性能"></a>使用 WebPageTest 评估网站性能</h2><p>程序员经常说的有句话是：“我这儿能打开啊。我这儿不报错呀。”大家应该都懂这个梗，这就是为什么，我们要借助第三方的测试工具，而不仅仅只是自己电脑上访问正常就ok了。</p>
<p>我们需要借助 WebPageTest 这样的第三方测试工具，去模拟各种用户的真实场景。</p>
<h3 id="WebPageTest-使用"><a href="#WebPageTest-使用" class="headerlink" title="WebPageTest 使用"></a>WebPageTest 使用</h3><p>网址：<a target="_blank" rel="noopener" href="https://www.webpagetest.org/">https://www.webpagetest.org</a></p>
<p><img src="http://img.smyhvae.com/20210115-2203.png"></p>
<p>WebPageTest 在世界各地提供了非常多的服务器，在每个服务器上部署了不同的浏览器，可以让我们有针对性的做测试。如果你做的是一款国际化网站，那更有必要使用一下了。</p>
<p>我们以JD网站举例：</p>
<p><img src="http://img.smyhvae.com/20210115-2225.png"></p>
<p>按照上面的选项配置完成后，点击右侧的「Start Test」即可开始测试。然后等待：</p>
<p><img src="http://img.smyhvae.com/20210115-2226.png"></p>
<h3 id="WebPageTest-报告分析"><a href="#WebPageTest-报告分析" class="headerlink" title="WebPageTest 报告分析"></a>WebPageTest 报告分析</h3><p>淘宝网站性能测试报告：</p>
<ul>
<li><p>2020年6月：<a target="_blank" rel="noopener" href="https://webpagetest.org/result/200616_JK_78eebda338285ffe0c2e154ca5032839/">https://webpagetest.org/result/200616_JK_78eebda338285ffe0c2e154ca5032839/</a></p>
</li>
<li><p>2021年1月：<a target="_blank" rel="noopener" href="https://www.webpagetest.org/result/210115_DiCB_f1344d732760365151755e89765b2d37/">https://www.webpagetest.org/result/210115_DiCB_f1344d732760365151755e89765b2d37/</a></p>
</li>
</ul>
<p>JD网站性能测试报告：</p>
<ul>
<li>2021年1月：<a target="_blank" rel="noopener" href="https://www.webpagetest.org/result/210115_DiGT_8d7370e91230b7d077e40b7aafb485a5/">https://www.webpagetest.org/result/210115_DiGT_8d7370e91230b7d077e40b7aafb485a5/</a></li>
</ul>
<p>拿到 WebPageTest 报告之后，我们来看看报告里的几个重点指标。</p>
<p><img src="http://img.smyhvae.com/20210116_1314.png"></p>
<p>1、摘要里的参数：（如上图）</p>
<ul>
<li>First Byte：第一个请求的响应时间。可以反映后台的处理能力，以及网络回路的情况。</li>
<li>Start Render：从白屏到首次渲染的时间。</li>
<li>Speed Index：速度指数。</li>
<li><strong>Total Blocking Time</strong>：页面被阻塞，导致用户不能交互的累计时间。</li>
</ul>
<p><img src="http://img.smyhvae.com/20210116_1315.png"></p>
<p>2、详情里的参数：<strong>First View</strong>。</p>
<p>First View展示的是：首次访问时，总的加载时间。这里面提供的瀑布图，比 chrome DevTools里提供的更为详细。</p>
<p>点击进入 First View 的详情之后，可以看到：所有的资源请求，都会在这里列出来。如下：</p>
<p><img src="http://img.smyhvae.com/20210116_1316.png"></p>
<ul>
<li>page is Interactive：页面在加载的过程中，大部分时间段，用户都是可以交互的。这是非常有用的一个指标。</li>
<li>Brower Main thread：浏览器主线程的占用情况。可以看看空闲的时间多不多。</li>
<li>CPU Utilization：CPU的使用情况。</li>
<li>多张图片的资源请求。</li>
</ul>
<p><img src="http://img.smyhvae.com/20210116_1317.png"></p>
<p>上图中，我们可以看到：多张图片的开始请求时间都是相同的。也就是说，如果让资源做<strong>并行加载</strong>，我们就可以加大地减少加载时间，<strong>最终所消耗的时间就由最大的图片来决定</strong>。这是一个很好的优化技巧，至于具体是怎么实现的，可以自行了解。</p>
<p>另外，我们看到，有一部分的请求，被高亮出来了：</p>
<p><img src="http://img.smyhvae.com/20210115-2250.png"></p>
<p>上面这张图的意思是：302表示重定向，也就是说，这个资源已经不在原来请求的位置了，需要重定向才能找到真实的位置。这个地方其实可以做一个优化：</p>
<blockquote>
<p>不需要去访问之前的无效的资源，可以直接去访问重定向后的那个资源。</p>
</blockquote>
<h3 id="局域网部署-WebPageTest-工具"><a href="#局域网部署-WebPageTest-工具" class="headerlink" title="局域网部署 WebPageTest 工具"></a>局域网部署 WebPageTest 工具</h3><p>如果我们开发的页面，还没有上线，公网则无法访问。这个时候我们也想通过WebPageTest看看网站的性能，那要怎么办呢？</p>
<p>我们可以在局域网部署 WebPageTest 工具，具体方法可自行研究。</p>
<h2 id="chrome插件：PageSpeed-Insights"><a href="#chrome插件：PageSpeed-Insights" class="headerlink" title="chrome插件：PageSpeed Insights"></a>chrome插件：PageSpeed Insights</h2><p>另外，google官方也有一个网址：<a target="_blank" rel="noopener" href="https://developers.google.com/speed/pagespeed/insights/?hl=zh-cn">https://developers.google.com/speed/pagespeed/insights/?hl=zh-cn</a></p>
<p>但是这个网站在使用时，经常挂掉。</p>
<p>这个插件是2018年的，已经好几年没更新了。大家参考即可。</p>
<h2 id="实时动态测量性能的API"><a href="#实时动态测量性能的API" class="headerlink" title="实时动态测量性能的API"></a>实时动态测量性能的API</h2><p>Chrome DevTools能够检测各种性能参数，其实也是调用了一些性能相关的标准API。我们自己也可以直接在代码里调用这些api。</p>
<p>通过 <code>performance</code>对象提供的API，我们可以实时的、精细化、自定义测量性能，获取相应的参数。也可以把这些性能参数，打印到控制台，或者实时上报给后台监控系统。</p>
<h3 id="performance：获取常见性能参数"><a href="#performance：获取常见性能参数" class="headerlink" title="performance：获取常见性能参数"></a>performance：获取常见性能参数</h3><p>常见性能参数，计算公式如下：</p>
<blockquote>
<p>时间戳1减去时间戳2，得到的差值，就是我们想要看到的耗时。</p>
</blockquote>
<ul>
<li><p>DNS 解析耗时: domainLookupEnd - domainLookupStart</p>
</li>
<li><p>TCP 连接耗时: connectEnd - connectStart</p>
</li>
<li><p>SSL 安全连接耗时: connectEnd - secureConnectionStart</p>
</li>
<li><p>网络请求耗时 (TTFB): responseStart - requestStart</p>
</li>
<li><p>数据传输耗时: responseEnd - responseStart</p>
</li>
<li><p>DOM 解析耗时: domInteractive - responseEnd</p>
</li>
<li><p>资源加载耗时: loadEventStart - domContentLoadedEventEnd</p>
</li>
<li><p>First Byte时间: responseStart - domainLookupStart</p>
</li>
<li><p>白屏时间: responseEnd - fetchStart</p>
</li>
<li><p>首次可交互时间（<strong>TTI</strong>）: domInteractive - fetchStart</p>
</li>
<li><p>DOM Ready 时间: domContentLoadEventEnd - fetchStart</p>
</li>
<li><p>页面完全加载时间: loadEventStart - fetchStart</p>
</li>
<li><p>http 头部大小： transferSize - encodedBodySize</p>
</li>
<li><p>重定向次数：performance.navigation.redirectCount</p>
</li>
<li><p>重定向耗时: redirectEnd - redirectStart</p>
</li>
</ul>
<p>比如说，如果我们想要获取 TTI参数，代码可以这样写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算一些关键的性能指标</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">&#x27;load&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Time to Interactive</span></span><br><span class="line">    <span class="keyword">let</span> timing = performance.getEntriesByType(<span class="string">&#x27;navigation&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">console</span>.log(timing.domInteractive);</span><br><span class="line">    <span class="built_in">console</span>.log(timing.fetchStart);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> diff = timing.domInteractive - timing.fetchStart;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;TTI: &quot;</span> + diff); <span class="comment">// 打印 TTI 参数</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="观察长任务"><a href="#观察长任务" class="headerlink" title="观察长任务"></a>观察长任务</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> PerformanceObserver(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> list.getEntries()) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(entry)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">observer.observe(&#123;<span class="attr">entryTypes</span>: [<span class="string">&#x27;longtask&#x27;</span>]&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="页面可见性的状态监听"><a href="#页面可见性的状态监听" class="headerlink" title="页面可见性的状态监听"></a>页面可见性的状态监听</h3><p>使用场景举例：</p>
<ul>
<li>比如说，我们正在做一个视频网站（或者游戏页面）。如果用户当前没有在看这个视频，而是切换别的页面了。此时，我们可以对视频做节流等处理，避免造成性能的浪费。等用户再回到当前页面之后，再恢复之前的状态。</li>
<li>当设备进入待机模式时（用户按下电源键关闭屏幕），网站想要关闭设备声音。</li>
</ul>
<p>针对这种场景，我们可以使用<code>visibilitychange</code>进行监听：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 见面可见性的状态监听</span></span><br><span class="line"><span class="keyword">let</span> vEvent = <span class="string">&#x27;visibilitychange&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">document</span>.webkitHidden != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// webkit prefix detected</span></span><br><span class="line">    vEvent = <span class="string">&#x27;webkitvisibilitychange&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">visibilityChanged</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">document</span>.hidden || <span class="built_in">document</span>.webkitHidden) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Web page is hidden.&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Web page is visible.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.addEventListener(vEvent, visibilityChanged, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>



<h3 id="网络状况监听"><a href="#网络状况监听" class="headerlink" title="网络状况监听"></a>网络状况监听</h3><p>使用场景举例：</p>
<ul>
<li>高清图片按需加载：如果用户的网络条件较好，就加载高清图片资源；如果网络条件不好，就加载文件较小的图片资源。</li>
</ul>
<p>代码举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> type = connection.effectiveType;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateConnectionStatus</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// type是之前的网络状态，connection.effectiveType是当前最新的网络状态</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;Connection type changed from &quot;</span> + type + <span class="string">&quot; to &quot;</span> + connection.effectiveType);</span><br><span class="line"></span><br><span class="line">  type = connection.effectiveType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">connection.addEventListener(<span class="string">&#x27;change&#x27;</span>, updateConnectionStatus);</span><br></pre></td></tr></table></figure>

<p>打印结果举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection type changed from 4g to 3g</span><br></pre></td></tr></table></figure>

<h3 id="检测元素的可见状态，做曝光埋点"><a href="#检测元素的可见状态，做曝光埋点" class="headerlink" title="检测元素的可见状态，做曝光埋点"></a>检测元素的可见状态，做曝光埋点</h3><p>我们可以通过<code>IntersectionObserver：</code>这个API来检测元素的可见状态：</p>
<p><img src="http://img.smyhvae.com/20210117_1635.png"></p>
<p>做曝光上报的埋点：判断某个DOM（或者某个楼层）是否出现在视窗中，出现了就收集数据上报给服务端。</p>
<p>本质就是要计算某一元素和另一元素（视窗）的相对位置/相对可视状态，然后进行一些操作（一般是上报给服务端）。</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cnodejs.org/topic/5e0a0edb0696c446bf650dec">前端埋点之曝光实现</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Hugohui/vueTrackSdk">点击埋点和曝光卖点的封装</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/00-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AE%A4%E7%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/14-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/00-%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%AE%A4%E7%9F%A5/" class="post-title-link" itemprop="url">00-前端性能优化认知</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:52" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:52+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="前端性能优化认知"><a href="#前端性能优化认知" class="headerlink" title="前端性能优化认知"></a>前端性能优化认知</h2><h3 id="什么是前端性能优化"><a href="#什么是前端性能优化" class="headerlink" title="什么是前端性能优化"></a>什么是前端性能优化</h3><p>通常来讲，前端性能优化是指：从用户开始访问网站到整个页面完整地展现出来的过程中，通过各种优化策略和优化方法，让页面加载得更快，让用户的操作相应更及时，给用户更好的使用体验。</p>
<p>优化是在做什么：</p>
<p><img src="http://img.smyhvae.com/20210115-1507.png"></p>
<p>如上图所示，优化工作是围绕前端的基本工作原理展开的，包括：<strong>客户端和服务器端建立连接、加载资源、解析资源并渲染</strong>。</p>
<p>上方图片的来源：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/dev-channel/the-cost-of-javascript-84009f51e99e">The Cost Of JavaScript</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dwqs/blog/issues/59">[译]JavaScript 的时间消耗</a></li>
</ul>
<h3 id="性能优化的重要性（程序员角度）"><a href="#性能优化的重要性（程序员角度）" class="headerlink" title="性能优化的重要性（程序员角度）"></a>性能优化的重要性（程序员角度）</h3><p>当领导问：“<strong>为什么网页访问这么慢</strong>？”我们不能只是回答“<strong>网络不好</strong>”这么简单，网络不可能一直都不好。</p>
<p>每个程序员如果想要成长，就不能回避“性能优化”这个话题。很多人写了多年的代码，一直在构建样式、写业务逻辑。但是平凡的程序员之路，何时才是尽头？前端职业发展的瓶颈在哪儿？怎么才能从团队中脱颖而出？如何区分出平凡程序员/大牛程序员/架构师的分水岭？</p>
<p>职场晋升时，我们也要想一想：大部分人都在写业务代码，和别人相比，我的核心竞争力在哪里？除了<strong>技术深度、前端工程化、综合素质</strong>之外，还有其他的吗？<strong>性能优化</strong>，绝对是不能忽视的一方面。而且它是贯穿于开发和维护的的全过程。</p>
<p>前端工程化是侧重于<strong>提效</strong>，具体包括编译打包发布流程、物料中心、组件化等；而前端性能优化是侧重于<strong>体验</strong>。</p>
<p>公司评价一个程序员的价值，不是加班越多越好，也不是代码量越多越好，而是看他<strong>是否能解决其他人解决不了的一些技术难题或者瓶颈</strong>。</p>
<p><strong>大家都知道性能优化很重要，但是落实到具体，怎么去优化</strong>？这就需要我们深入去了解前端技术背后的原理，学习一些主流的前端性能优化技术方案，掌握性能优化技术，提升Web性能，才能总结出相应的优化方案，而且需要多年的经验积累；进而到达前端技术圈的上游，提高自己的核心竞争力。</p>
<h3 id="前端性能优化面试"><a href="#前端性能优化面试" class="headerlink" title="前端性能优化面试"></a>前端性能优化面试</h3><p>性能优化是前端面试的必考问题，面试者在回答这个问题时，大致情况如下：</p>
<ul>
<li><p>70% 的人上来就说减少合并资源、减少请求、数据缓存这些优化手段。</p>
</li>
<li><p>15% 的人会提到需要在 DevTools 下先看看首屏时间，可以先围绕首屏来做优化。</p>
</li>
<li><p>10%的人会提到需要接入一个性能平台来看看现状，诊断一下。</p>
</li>
<li><p>而只有 5% 的人会从前端性能体系来系统考虑性能优化。</p>
</li>
</ul>
<p>面试官期待的是你在什么场景下，遇到了什么性能问题，围绕什么样的性能指标，采取了哪些性能优化手段，最后取得了什么样的结果，而不仅仅是直接说采取了哪些优化手段。</p>
<p>比如说，“<strong>为什么首页打开慢</strong>？”    面试官期待的是，前端能和后端一样，通过查日志和数据就能定位问题，而不是停留在猜测层面。但在实际当中，能做到这点的前端同学并不多。</p>
<p>那么，前端有没有这样的工具呢？有，那就是性能监控平台。平台上面有各个业务的性能指标及其对应场景下的性能标准，一旦遇到性能问题，就能直接判断当前性能数据有没有问题，然后提示问题是出在前端、后端，还是网络层。</p>
<h3 id="性能优化的意义"><a href="#性能优化的意义" class="headerlink" title="性能优化的意义"></a>性能优化的意义</h3><p>1、随着互联网的发展，<strong>网页的内容越来越丰富，功能越来越强大，页面也越做越漂亮</strong>；带来的问题是，访问速度和体验会收到影响。只有对网站进行持续不断的优化，才能保证网页的访问速度可以跟得上用户体验的需求。</p>
<p>2、<strong>高性能</strong>可以带来更高的<strong>用户参与度</strong>、<strong>用户留存</strong>，进而带来更高的<strong>转化率</strong>和<strong>SEO排名</strong>，更好的<strong>用户体验</strong>，最终带来更高的<strong>业务收益</strong>。</p>
<p>随着时间的推移，如果一个网站由于各种原因导致心梗越来越差，以至于用户每打开一个页面都要等待很长时间，甚至出现加载失败的情况，那么，不仅新用户不会沉淀下来，老用户也会纷纷离去，最终导致产品的加速衰败。</p>
<p>而且网站的加载快慢，最产品收入有着直接的影响。<strong>有数据表明：网页加载时间在5秒内的网站比加载时间为19秒的网站，广告收入会增加近一倍</strong>。也就是说，网站或者App的性能直接关系到产品的用户增长和收入增长。</p>
<p>正因为如此，我们才需要通过性能优化的技巧，并结合其他的技术手段来不断提高网站和App的用户体验，从而助力公司的业务增长；同时，我们也可以借此提升自己的技术实力，这对个人的职业成长也会以后很大的帮助。</p>
<p>3、只要产品上线了，随着<strong>业务规模量和用户访问量的扩大</strong>，性能优化就是不可回避的话题。在遇到性能问题时，有些人的解决办法是：用一些粗糙的手段把问题绕过去，但却给后面的人埋下了坑。这些人常说的依据口头禅是：</p>
<p><img src="http://img.smyhvae.com/20210115-2150.jpg"></p>
<h3 id="相关案例"><a href="#相关案例" class="headerlink" title="相关案例"></a>相关案例</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.gigaspaces.com/blog/amazon-found-every-100ms-of-latency-cost-them-1-in-sales/">Amazon发现每100ms延迟导致1%的销量损失</a>。</p>
</li>
<li><p>歌地图首页文件从100KB减少到70KB，流量在第一周涨了10%，在接下来的三周涨了25%。</p>
</li>
<li><p>腾讯根据长期数据监控发现，页面一秒钟延迟会造成页面访问量下降9.4%，跳出率增加8.3%，转化率下降3.5%。</p>
</li>
</ul>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>有些同学做事有拖延症，经常喜欢刷朋友圈、刷微博、看新闻，导致工作效率很低。为了解决这个问题，其实有个办法就是：把你的浏览器或者指定的软件，添加一个5秒的延迟，这时候，当你访问所有的网站，都会很慢。坚持一个月，你会发现，你再也不想看这些网站了，工作效率明显提升了许多。</p>
<p>这件事情从侧面也反映出：网站的性能如果不够好，对用户来说是一种折磨。时间一长，用户就不想用这个网站了。性能和网站的利益直接相关。涉及到：流量、搜索、转化率、用户体验。</p>
<h2 id="如何学习性能优化"><a href="#如何学习性能优化" class="headerlink" title="如何学习性能优化"></a>如何学习性能优化</h2><h3 id="学习难点"><a href="#学习难点" class="headerlink" title="学习难点"></a>学习难点</h3><p>我们在网上找到的文章，有很多都只是对CSS、JS技术本身的优化，一旦涉及到App、后端、网络等不是很熟悉的领域，学习起来就比较困难了。结合具体业务开发的应用场景时，却不知从何下手。因此，<strong>我们需要要由点及面，学习全链路前端性能优化的知识体系和解决方案</strong>。</p>
<p>在实际工作当中，前端性能优化往往比较繁杂，学习难点主要体现在以下几个方面：todo</p>
<h3 id="优化标准"><a href="#优化标准" class="headerlink" title="优化标准"></a>优化标准</h3><p>我们在做优化时，需要有一个量化标准，比如：</p>
<ul>
<li><p>loading 要做到什么效果、动画要达到什么效果才是好的？</p>
</li>
<li><p>所有的事件处理，要在什么时间内完成，才能给用户良好的体验？</p>
</li>
</ul>
<h3 id="技术储备前提"><a href="#技术储备前提" class="headerlink" title="技术储备前提"></a>技术储备前提</h3><ul>
<li><p>掌握前端基础知识。</p>
</li>
<li><p>具备Web开发实战经验。</p>
</li>
</ul>
<h3 id="寻找性能瓶颈"><a href="#寻找性能瓶颈" class="headerlink" title="寻找性能瓶颈"></a>寻找性能瓶颈</h3><ul>
<li><p>了解性能指标，多快才算快。</p>
</li>
<li><p>利用测量工具和API</p>
</li>
<li><p>优化问题，重新测量。持续迭代。</p>
</li>
</ul>
<h3 id="移动端挑战多"><a href="#移动端挑战多" class="headerlink" title="移动端挑战多"></a>移动端挑战多</h3><ul>
<li><p>移动端的硬件不如PC端，且网络不稳定。</p>
</li>
<li><p>屏幕尺寸和交互方式都是挑战。</p>
</li>
<li><p>移动端用户更佳缺乏耐心。而且，很多用户是利用碎片化时间访问网页。数据参考： <strong>&gt;3秒</strong>的加载时间，导致 53%的跳出率（bounce rate）。</p>
</li>
<li><p>持续增长的移动端用户和电商业务。现在很多事情都是在移动端做的。</p>
</li>
</ul>
<h3 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h3><ul>
<li><p>由浅入深：解读优化技术内幕。</p>
</li>
<li><p>流行+经典：了解技术背后的设计思想。</p>
</li>
<li><p>了解性能优化的关键环节，升级知识储备。</p>
</li>
</ul>
<ul>
<li><p>理论+实践：掌握前端业界的流行且成熟的多种性能优化技术，脱颖而出。</p>
</li>
<li><p>了解大厂正在用的生产环境级别的高性能解决方案。</p>
</li>
</ul>
<h2 id="前端性能优化全过程"><a href="#前端性能优化全过程" class="headerlink" title="前端性能优化全过程"></a>前端性能优化全过程</h2><h3 id="1、静态资源优化"><a href="#1、静态资源优化" class="headerlink" title="1、静态资源优化"></a>1、静态资源优化</h3><p>静态资源优化包括html、css、js、图片等资源的性能优化。包括：</p>
<ul>
<li><p>图片的应用场景和使用</p>
</li>
<li><p>html、css、js的具体优化策略</p>
</li>
</ul>
<ul>
<li><p>资源文件的优化：比如文件压缩合并策略、打包方案、版本号更新方案</p>
</li>
<li><p>前端工程化工具等。</p>
</li>
</ul>
<h3 id="2、页面渲染架构设计及相关的技术方案选型"><a href="#2、页面渲染架构设计及相关的技术方案选型" class="headerlink" title="2、页面渲染架构设计及相关的技术方案选型"></a>2、页面渲染架构设计及相关的技术方案选型</h3><p>按照技术方案的分类，包括：</p>
<ul>
<li><p>前后端分离技术</p>
</li>
<li><p>SPA单页应用</p>
</li>
<li><p>BigPipe</p>
</li>
<li><p>同构直出</p>
</li>
<li><p>PWA</p>
</li>
<li><p>页面加载策略</p>
</li>
<li><p>接口服务调优、接口缓存策略</p>
</li>
<li><p>大型网站背后的实际性能优化案例</p>
</li>
<li><p>前端组件化、模块化，加速业务开发</p>
</li>
</ul>
<h3 id="3、原生App优化、混合开发优化"><a href="#3、原生App优化、混合开发优化" class="headerlink" title="3、原生App优化、混合开发优化"></a>3、原生App优化、混合开发优化</h3><ul>
<li><p>浏览器的整体优化方案。比如导航条、登录态、滚动条优化等。</p>
</li>
<li><p>前端缓存策略和优化</p>
</li>
<li><p>H5静态资源请求代理的技术原理</p>
</li>
<li><p>H5离线技术，达到页面秒开的目标</p>
</li>
<li><p>混合式开发解决方案</p>
</li>
<li><p>RN、小程序、flutter等</p>
</li>
</ul>
<h3 id="4、服务端与网络优化"><a href="#4、服务端与网络优化" class="headerlink" title="4、服务端与网络优化"></a>4、服务端与网络优化</h3><ul>
<li><p>CDN 和 DNS 优化</p>
</li>
<li><p>如何减少 http 请求数、减少cookie大小</p>
</li>
<li><p>nginx缓存配置和优化</p>
</li>
<li><p>开启和配置 gzip 压缩</p>
</li>
<li><p>如何开启全站 https</p>
</li>
<li><p>升级 Http2.0 的好处和方法</p>
</li>
</ul>
<h3 id="5、研发流程优化"><a href="#5、研发流程优化" class="headerlink" title="5、研发流程优化"></a>5、研发流程优化</h3><ul>
<li><p>技术调用的方法</p>
</li>
<li><p>前后端接口约定、加快前后端接口联调</p>
</li>
<li><p>前端自动化测试</p>
</li>
<li><p>自动化部署和上线</p>
</li>
<li><p>从研发的整体流程层面梳理出提升研发效率的方式和方法。</p>
</li>
</ul>
<h3 id="6、全链路质量监控体系建设"><a href="#6、全链路质量监控体系建设" class="headerlink" title="6、全链路质量监控体系建设"></a>6、全链路质量监控体系建设</h3><p>主要是对性能优化的结果进行衡量、打分、考核：</p>
<ul>
<li><p>上线前，页面质量及时检测</p>
</li>
<li><p>上线后，页面性能和错误监控</p>
</li>
<li><p>线上运行时，页面的可用性监控</p>
</li>
<li><p>愿生App的性能和错误监控</p>
</li>
</ul>
<h2 id="前端性能优化包括哪些方面"><a href="#前端性能优化包括哪些方面" class="headerlink" title="前端性能优化包括哪些方面"></a>前端性能优化包括哪些方面</h2><h3 id="1、性能优化指标与测量工具"><a href="#1、性能优化指标与测量工具" class="headerlink" title="1、性能优化指标与测量工具"></a>1、性能优化指标与测量工具</h3><ul>
<li><p>行业标准</p>
</li>
<li><p>优化模型</p>
</li>
<li><p>性能测量工具：了解性能情况，并对比</p>
</li>
<li><p>性能相关APIs</p>
</li>
</ul>
<h3 id="2、渲染优化"><a href="#2、渲染优化" class="headerlink" title="2、渲染优化"></a>2、渲染优化</h3><ul>
<li><p>现代浏览器的渲染原理</p>
</li>
<li><p>可优化的渲染环节和方法</p>
</li>
</ul>
<h3 id="3、代码优化"><a href="#3、代码优化" class="headerlink" title="3、代码优化"></a>3、代码优化</h3><ul>
<li><p>JS优化：了解JS的开销、解析、优化方案，以及如何配合V8引擎做更有效的优化。</p>
</li>
<li><p>html优化</p>
</li>
<li><p>css优化</p>
<h3 id="4、资源优化"><a href="#4、资源优化" class="headerlink" title="4、资源优化"></a>4、资源优化</h3></li>
<li><p>压缩合并</p>
</li>
<li><p>图片格式</p>
</li>
<li><p>图片加载</p>
</li>
<li><p>字体优化</p>
</li>
</ul>
<h3 id="5、构建优化"><a href="#5、构建优化" class="headerlink" title="5、构建优化"></a>5、构建优化</h3><ul>
<li><p>webpack 优化配置</p>
</li>
<li><p>代码拆分</p>
</li>
<li><p>代码压缩</p>
</li>
<li><p>持久化缓存</p>
</li>
<li><p>监测与分析</p>
</li>
<li><p>按需加载</p>
</li>
</ul>
<h3 id="6、传输和加载优化"><a href="#6、传输和加载优化" class="headerlink" title="6、传输和加载优化"></a>6、传输和加载优化</h3><ul>
<li><p>gZip</p>
</li>
<li><p>KeepAlive</p>
</li>
<li><p>HTTP缓存</p>
</li>
<li><p>Service Worker</p>
</li>
<li><p>HTTP/2</p>
</li>
<li><p>SSR 服务端渲染</p>
</li>
<li><p>Nginx</p>
<h3 id="7、更多主流优化方案"><a href="#7、更多主流优化方案" class="headerlink" title="7、更多主流优化方案"></a>7、更多主流优化方案</h3></li>
</ul>
<ul>
<li><p>SVG 优化图标</p>
</li>
<li><p>FlexBox 布局</p>
</li>
<li><p>预加载</p>
</li>
<li><p>预渲染</p>
</li>
<li><p>窗口化提高列表性能</p>
</li>
<li><p>骨架屏</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/13-React%E5%9F%BA%E7%A1%80/11-React%20Navive%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/13-React%E5%9F%BA%E7%A1%80/11-React%20Navive%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">11-React Navive初识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:49" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:49+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h2><p>官方文档：<a target="_blank" rel="noopener" href="https://reactnative.cn/docs/getting-started.html">https://reactnative.cn/docs/getting-started.html</a></p>
<h3 id="安装Node、homebrew、Watchman"><a href="#安装Node、homebrew、Watchman" class="headerlink" title="安装Node、homebrew、Watchman"></a>安装Node、homebrew、Watchman</h3><p>安装 homebrew：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>安装 watchman：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install watchman</span><br></pre></td></tr></table></figure>


<p>Watchman则是由 Facebook 提供的监视文件系统变更的工具。安装此工具可以提高开发时的性能（packager 可以快速捕捉文件的变化从而实现实时刷新）。</p>
<h3 id="安装-React-Native-的命令行工具（react-native-cli）"><a href="#安装-React-Native-的命令行工具（react-native-cli）" class="headerlink" title="安装 React Native 的命令行工具（react-native-cli）"></a>安装 React Native 的命令行工具（react-native-cli）</h3><p>安装 react-native-cli：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g react-native-cli</span><br></pre></td></tr></table></figure>


<p>React Native 的命令行工具用于执行创建、初始化、更新项目、运行打包服务（packager）等任务。</p>
<h3 id="创建新项目"><a href="#创建新项目" class="headerlink" title="创建新项目"></a>创建新项目</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native init MyApp --version 0.44.3</span><br></pre></td></tr></table></figure>

<h3 id="编译并运行-React-Native-应用"><a href="#编译并运行-React-Native-应用" class="headerlink" title="编译并运行 React Native 应用"></a>编译并运行 React Native 应用</h3><p>在 ios 模拟器上运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native run-ios</span><br></pre></td></tr></table></figure>

<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>官网文档：<a target="_blank" rel="noopener" href="https://reactnative.cn/docs/debugging.html">https://reactnative.cn/docs/debugging.html</a></p>
<h3 id="访问-App-内的开发菜单"><a href="#访问-App-内的开发菜单" class="headerlink" title="访问 App 内的开发菜单"></a>访问 App 内的开发菜单</h3><p>如果是在 iOS 模拟器中运行，还可以按下<code>Command + D</code>快捷键，Android 模拟器对应的则是Command⌘ + M（windows 上可能是 F1 或者 F2），或是直接在命令行中运行adb shell input keyevent 82来发送菜单键命令。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/13-React%E5%9F%BA%E7%A1%80/10-AntD%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E4%BD%BF%E7%94%A8customRequest%E6%96%B9%E6%B3%95%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E8%A1%8C%E4%B8%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/13-React%E5%9F%BA%E7%A1%80/10-AntD%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E4%BD%BF%E7%94%A8customRequest%E6%96%B9%E6%B3%95%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E8%A1%8C%E4%B8%BA/" class="post-title-link" itemprop="url">10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:49" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:49+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<p>本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 <a target="_blank" rel="noopener" href="https://ant.design/components/upload-cn/">upload</a> 组件。</p>
<p>我在上一篇文章《<a target="_blank" rel="noopener" href="https://www.cnblogs.com/qianguyihao/p/10460834.html">前端AntD框架的upload组件上传图片时遇到的一些坑</a>》中讲到：AntD 的 upload 组件有很多坑，引起了很多人的关注。折腾过的人，自然明白其中的苦楚。</p>
<p>今天这篇文章，我们继续来研究 AntD 的 upload 组件的另一个坑。</p>
<p>备注：本文写于2020-06-11，使用的 antd 版本是 3.13.6。</p>
<h2 id="使用-AntD-的-upload-组件做图片的上传，效果演示"><a href="#使用-AntD-的-upload-组件做图片的上传，效果演示" class="headerlink" title="使用 AntD 的 upload 组件做图片的上传，效果演示"></a>使用 AntD 的 upload 组件做图片的上传，效果演示</h2><p>因为需要上传多张图片，所以采用的是照片墙的形式。上传成功后的界面如下：</p>
<p>（1）上传中：</p>
<p><img src="http://img.smyhvae.com/20190302_1335.png"></p>
<p>（2）上传成功：</p>
<p><img src="http://img.smyhvae.com/20190302_1336.png"></p>
<p>（3）图片预览：</p>
<p><img src="http://img.smyhvae.com/20190302_1331.png"></p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>首先，你需要让后台同学提供好图片上传的接口。上一篇文章中，我们是把接口调用直接写在了 <code>&lt;Upload&gt;</code> 标签的 action 属性当中。但如果你在调接口的时候，动作很复杂（比如根据业务要求，需要连续调两个接口才能上传图片，或者在调接口时还要做其他的事情），这个 action 方法就无法满足需求了。那该怎么做呢？</p>
<p>好在 AntD 的 upload 组件给我们提供了 <code>customRequest</code>这个方法：</p>
<p><img src="http://img.smyhvae.com/20200611_1543.png"></p>
<p>关于customRequest 这个方法， AntD 官方并没有给出示例，他们只是在 GitHub 上给出了这样一个简短的介绍：</p>
<p><img src="http://img.smyhvae.com/20200611_1536.png"></p>
<p>但这个方法怎么用呢？用的时候，会遇到什么问题呢？AntD 官方没有说。我在网上搜了半天，也没看到比较完整的、切实可行的 Demo。我天朝地大物博，网络资料浩如烟海，AntD 可是口口声声被人们号称是天朝最好用的管理后台的样式框架。可如今，却面临这样的局面。我看着你们，满怀羡慕。</p>
<p>既然如此，那我就自己研究吧。折腾了一天，总算是把 customRequest 的坑踩得差不多了。</p>
<p>啥也不说了，直接上代码。</p>
<p>采用 AntD框架的 <a target="_blank" rel="noopener" href="https://ant.design/components/upload-cn/">upload</a> 组件的 customRequest 方法，自定义上传行为。核心代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; PureComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Button, Card, Form, message, Upload, Icon, Modal, Row, Col &#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;dva&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; queryMyData, submitData &#125; <span class="keyword">from</span> <span class="string">&#x27;../api&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; uploadImage &#125; <span class="keyword">from</span> <span class="string">&#x27;../../utils/wq.img.upload&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;../../utils/form.less&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FormItem = Form.Item;</span><br><span class="line"></span><br><span class="line">@Form.create()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">PicturesWall</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">props</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = <span class="built_in">this</span>.props.match.params;</span><br><span class="line">    <span class="built_in">this</span>.state = &#123;</span><br><span class="line">      id,</span><br><span class="line">      <span class="attr">img</span>: <span class="literal">undefined</span>, <span class="comment">// 从接口拿到的图片字段</span></span><br><span class="line">      <span class="attr">imgList</span>: [], <span class="comment">// 展示在 antd图片组件上的数据</span></span><br><span class="line">      <span class="attr">previewVisible</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">previewImage</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    id &amp;&amp; <span class="built_in">this</span>.queryData();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调接口，查询已有的数据</span></span><br><span class="line">  <span class="function"><span class="title">queryData</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    queryMyData(&#123;</span><br><span class="line">      id,</span><br><span class="line">    &#125;)</span><br><span class="line">      .then(<span class="function">(<span class="params">&#123; ret, data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span> &amp;&amp; data &amp;&amp; data.list &amp;&amp; data.list.length) &#123;</span><br><span class="line">          <span class="keyword">const</span> item = data.list[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> img = data.img;</span><br><span class="line">          <span class="keyword">const</span> imgList = item.img</span><br><span class="line">            ? [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">uid</span>: <span class="string">&#x27;1&#x27;</span>, <span class="comment">// 注意，这个uid一定不能少，否则展示失败</span></span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;hehe.png&#x27;</span>,</span><br><span class="line">                <span class="attr">status</span>: <span class="string">&#x27;done&#x27;</span>,</span><br><span class="line">                <span class="attr">url</span>: img,</span><br><span class="line">              &#125;,</span><br><span class="line">            ]</span><br><span class="line">            : [];</span><br><span class="line"></span><br><span class="line">          <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">            img,</span><br><span class="line">            imgList,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">Promise</span>.reject();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        message.error(<span class="string">&#x27;查询出错，请重试&#x27;</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleCancel = <span class="function">() =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">previewVisible</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法：图片预览</span></span><br><span class="line">  handlePreview = <span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae handlePreview:&#x27;</span> + <span class="built_in">JSON</span>.stringify(file));</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">previewImage</span>: file.url || file.thumbUrl,</span><br><span class="line">      <span class="attr">previewVisible</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参考链接：https://www.jianshu.com/p/f356f050b3c9</span></span><br><span class="line">  handleBeforeUpload = <span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae handleBeforeUpload file:&#x27;</span> + <span class="built_in">JSON</span>.stringify(file));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae handleBeforeUpload file.file:&#x27;</span> + <span class="built_in">JSON</span>.stringify(file.file));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae handleBeforeUpload file type:&#x27;</span> + <span class="built_in">JSON</span>.stringify(file.type));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//限制图片 格式、size、分辨率</span></span><br><span class="line">    <span class="keyword">const</span> isJPG = file.type === <span class="string">&#x27;image/jpeg&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isJPEG = file.type === <span class="string">&#x27;image/jpeg&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isGIF = file.type === <span class="string">&#x27;image/gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isPNG = file.type === <span class="string">&#x27;image/png&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isLt2M = file.size / <span class="number">1024</span> / <span class="number">1024</span> &lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(isJPG || isJPEG || isPNG)) &#123;</span><br><span class="line">      Modal.error(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;只能上传JPG、JPEG、PNG格式的图片~&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isLt2M) &#123;</span><br><span class="line">      Modal.error(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;图片超过1M限制，不允许上传~&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (isJPG || isJPEG || isPNG) &amp;&amp; isLt2M;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// checkImageWH  返回一个promise  检测通过返回resolve  失败返回reject阻止图片上传</span></span><br><span class="line">  <span class="function"><span class="title">checkImageWH</span>(<span class="params">file</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> filereader = <span class="keyword">new</span> FileReader();</span><br><span class="line">      filereader.onload = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> src = e.target.result;</span><br><span class="line">        <span class="keyword">const</span> image = <span class="keyword">new</span> Image();</span><br><span class="line">        image.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="comment">// 获取图片的宽高</span></span><br><span class="line">          file.width = <span class="built_in">this</span>.width;</span><br><span class="line">          file.height = <span class="built_in">this</span>.height;</span><br><span class="line">          resolve();</span><br><span class="line">        &#125;;</span><br><span class="line">        image.onerror = reject;</span><br><span class="line">        image.src = src;</span><br><span class="line">      &#125;;</span><br><span class="line">      filereader.readAsDataURL(file);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 图片上传</span></span><br><span class="line">  doImgUpload = <span class="function">(<span class="params">options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; onSuccess, onError, file, onProgress &#125; = options;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start：进度条相关</span></span><br><span class="line">    <span class="comment">// 伪装成 handleChange里面的图片上传状态</span></span><br><span class="line">    <span class="keyword">const</span> imgItem = &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="string">&#x27;1&#x27;</span>, <span class="comment">// 注意，这个uid一定不能少，否则上传失败</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;hehe.png&#x27;</span>,</span><br><span class="line">      <span class="attr">status</span>: <span class="string">&#x27;uploading&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">percent</span>: <span class="number">99</span>, <span class="comment">// 注意不要写100。100表示上传完成</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">imgList</span>: [imgItem],</span><br><span class="line">    &#125;); <span class="comment">// 更新 imgList</span></span><br><span class="line">    <span class="comment">// end：进度条相关</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">    reader.readAsDataURL(file); <span class="comment">// 读取图片文件</span></span><br><span class="line"></span><br><span class="line">    reader.onload = <span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> params = &#123;</span><br><span class="line">        <span class="attr">myBase64</span>: file.target.result, <span class="comment">// 把 本地图片的base64编码传给后台，调接口，生成图片的url</span></span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 上传图片的base64编码，调接口后，返回 imageId</span></span><br><span class="line">      uploadImage(params)</span><br><span class="line">        .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae doImgUpload:&#x27;</span> + <span class="built_in">JSON</span>.stringify(res));</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae 图片上传成功：&#x27;</span> + res.imageUrl);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> imgItem = &#123;</span><br><span class="line">            <span class="attr">uid</span>: <span class="string">&#x27;1&#x27;</span>, <span class="comment">// 注意，这个uid一定不能少，否则上传失败</span></span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;hehe.png&#x27;</span>,</span><br><span class="line">            <span class="attr">status</span>: <span class="string">&#x27;done&#x27;</span>,</span><br><span class="line">            <span class="attr">url</span>: res.imageUrl, <span class="comment">// url 是展示在页面上的绝对链接</span></span><br><span class="line">            <span class="attr">imgUrl</span>: res.imageUrl, <span class="comment">// imgUrl 是存到 db 里的相对链接</span></span><br><span class="line">            <span class="comment">// response: &#x27;&#123;&quot;status&quot;: &quot;success&quot;&#125;&#x27;,</span></span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">            <span class="attr">imgList</span>: [imgItem],</span><br><span class="line">          &#125;); <span class="comment">// 更新 imgList</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae 图片上传失败:&#x27;</span> + <span class="built_in">JSON</span>.stringify(e || <span class="string">&#x27;&#x27;</span>));</span><br><span class="line">          message.error(<span class="string">&#x27;图片上传失败，请重试&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleChange = <span class="function">(<span class="params">&#123; file, fileList &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae handleChange file:&#x27;</span> + <span class="built_in">JSON</span>.stringify(file));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae handleChange fileList:&#x27;</span> + <span class="built_in">JSON</span>.stringify(fileList));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file.status == <span class="string">&#x27;removed&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">        <span class="attr">imgList</span>: [],</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  submit = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.props.form.validateFields(<span class="function">(<span class="params">err, fieldsValue</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; id, imgList &#125; = <span class="built_in">this</span>.state;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> tempImgList = imgList.filter(<span class="function">(<span class="params">item</span>) =&gt;</span> item.status == <span class="string">&#x27;done&#x27;</span>); <span class="comment">// 筛选出 status = done 的图片</span></span><br><span class="line">      <span class="keyword">const</span> imgArr = [];</span><br><span class="line">      tempImgList.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        imgArr.push(item.imgUrl);</span><br><span class="line">        <span class="comment">// imgArr.push(item.url);</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      submitData(&#123;</span><br><span class="line">        id,</span><br><span class="line">        <span class="attr">img</span>: imgArr[<span class="number">0</span>] || <span class="string">&#x27;&#x27;</span>, <span class="comment">// 1、暂时只传一张图片给后台。如果传多张图片，那么，upload组件需要进一步完善，比较麻烦，以后有需求再优化。2、如果图片字段是选填，那就用空字符串兜底</span></span><br><span class="line">      &#125;)</span><br><span class="line">        .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (res.ret == <span class="number">0</span>) &#123;</span><br><span class="line">            message.success(<span class="string">`<span class="subst">$&#123;id ? <span class="string">&#x27;修改&#x27;</span> : <span class="string">&#x27;新增&#x27;</span>&#125;</span>成功，自动跳转中...`</span>);</span><br><span class="line"></span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.ret == <span class="number">201</span> || res.ret == <span class="number">202</span> || res.ret == <span class="number">203</span> || res.ret == <span class="number">6</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(res.msg);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">          message.error(e || <span class="string">&#x27;提交失败，请重试&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, imgList &#125; = <span class="built_in">this</span>.state;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae render imgList:&#x27;</span> + <span class="built_in">JSON</span>.stringify(imgList));</span><br><span class="line">    <span class="keyword">const</span> &#123; getFieldDecorator &#125; = <span class="built_in">this</span>.props.form;</span><br><span class="line">    <span class="keyword">const</span> formItemLayout = &#123;</span><br><span class="line">      <span class="attr">labelCol</span>: &#123; <span class="attr">span</span>: <span class="number">3</span> &#125;,</span><br><span class="line">      <span class="attr">wrapperCol</span>: &#123; <span class="attr">span</span>: <span class="number">10</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> buttonItemLayout = &#123;</span><br><span class="line">      <span class="attr">wrapperCol</span>: &#123; <span class="attr">span</span>: <span class="number">10</span>, <span class="attr">offset</span>: <span class="number">3</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uploadButton = (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;plus&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;ant-upload-text&quot;</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">Card</span> <span class="attr">title</span>=<span class="string">&#123;id</span> ? &#x27;修改信息&#x27; <span class="attr">:</span> &#x27;新增信息&#x27;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;this.submit&#125;</span> <span class="attr">layout</span>=<span class="string">&quot;horizontal&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">          &#123;/* 新建图片、编辑图片 */&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;图片&quot;</span> &#123;<span class="attr">...formItemLayout</span>&#125;&gt;</span></span></span><br><span class="line"><span class="xml">            &#123;getFieldDecorator(&#x27;img&#x27;, &#123;</span></span><br><span class="line"><span class="xml">              rules: [&#123; required: false, message: &#x27;请上传图片&#x27; &#125;],</span></span><br><span class="line"><span class="xml">            &#125;)(</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;<span class="name">Upload</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">action</span>=<span class="string">&quot;2&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">customRequest</span>=<span class="string">&#123;this.doImgUpload&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">listType</span>=<span class="string">&quot;picture-card&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">fileList</span>=<span class="string">&#123;imgList&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">onPreview</span>=<span class="string">&#123;this.handlePreview&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">beforeUpload</span>=<span class="string">&#123;this.handleBeforeUpload&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">onChange</span>=<span class="string">&#123;this.handleChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">              &gt;</span></span></span><br><span class="line"><span class="xml">                &#123;imgList.length &gt;= 1 ? null : uploadButton&#125;</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;/<span class="name">Upload</span>&gt;</span></span></span><br><span class="line"><span class="xml">            )&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">Row</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;3&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;18&#125;</span> <span class="attr">className</span>=<span class="string">&#123;styles.graytext&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">              注：图片支持JPG、JPEG、PNG格式，小于1M，最多上传1张</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Col</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">Row</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">FormItem</span> &#123;<span class="attr">...buttonItemLayout</span>&#125;&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">htmlType</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">              提交</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        &#123;/* 图片点开预览 */&#125;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Modal</span> <span class="attr">visible</span>=<span class="string">&#123;this.state.previewVisible&#125;</span> <span class="attr">footer</span>=<span class="string">&#123;null&#125;</span> <span class="attr">onCancel</span>=<span class="string">&#123;this.handleCancel&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;example&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> &#x27;<span class="attr">100</span>%&#x27; &#125;&#125; <span class="attr">src</span>=<span class="string">&#123;this.state.previewImage&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Modal</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">Card</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>注意file的格式：<a target="_blank" rel="noopener" href="https://www.lmonkey.com/t/oREQA5XE1">https://www.lmonkey.com/t/oREQA5XE1</a></p>
<p>Demo在线演示：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/58128062/using-customrequest-in-ant-design-file-upload">https://stackoverflow.com/questions/58128062/using-customrequest-in-ant-design-file-upload</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackblitz.com/edit/so-58128062-upload-progress">https://stackblitz.com/edit/so-58128062-upload-progress</a></p>
</li>
</ul>
<p>fileList 格式在线演示：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/51514757/action-function-is-required-with-antd-upload-control-but-i-dont-need-it">https://stackoverflow.com/questions/51514757/action-function-is-required-with-antd-upload-control-but-i-dont-need-it</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://codesandbox.io/s/rl7ooo544q">https://codesandbox.io/s/rl7ooo544q</a></p>
</li>
</ul>
<p>ant design Upload组件的使用总结：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0aa4612af987">https://www.jianshu.com/p/0aa4612af987</a></p>
<p>antd上传功能的CustomRequest：<a target="_blank" rel="noopener" href="https://mlog.club/article/3832743">https://mlog.club/article/3832743</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/01/13-React%E5%9F%BA%E7%A1%80/09-AntD%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="张天伟">
      <meta itemprop="description" content="欢迎访问！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天伟小站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/01/13-React%E5%9F%BA%E7%A1%80/09-AntD%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/" class="post-title-link" itemprop="url">09-AntD框架的upload组件上传图片时遇到的一些坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-01 10:00:49" itemprop="dateCreated datePublished" datetime="2021-12-01T10:00:49+08:00">2021-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-28 12:47:39" itemprop="dateModified" datetime="2021-11-28T12:47:39+08:00">2021-11-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><ArticleTopAd></ArticleTopAd></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 <a target="_blank" rel="noopener" href="https://ant.design/components/upload-cn/">upload</a> 组件。</p>
<p>前端做文件上传这个功能，是很有技术难度的。既然框架给我们提供好了，那就直接用呗。结果用的时候，发现 upload 组件的很多bug。下面来列举几个。</p>
<p>备注：本文写于2019-03-02，使用的 antd 版本是 3.13.6。</p>
<h2 id="使用-AntD-的-upload-组件做图片的上传"><a href="#使用-AntD-的-upload-组件做图片的上传" class="headerlink" title="使用 AntD 的 upload 组件做图片的上传"></a>使用 AntD 的 upload 组件做图片的上传</h2><p>因为需要上传多张图片，所以采用的是照片墙的形式。上传成功后的界面如下：</p>
<p>（1）上传中：</p>
<p><img src="http://img.smyhvae.com/20190302_1335.png"></p>
<p>（2）上传成功：</p>
<p><img src="http://img.smyhvae.com/20190302_1336.png"></p>
<p>（3）图片预览：</p>
<p><img src="http://img.smyhvae.com/20190302_1331.png"></p>
<p>按照官方提供的实例，特此整理出项目开发中的完整写法，亲测有效。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Upload, Icon, Modal, Form &#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FormItem = Form.Item;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PicturesWall</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">previewVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">previewImage</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">imgList</span>: [],</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  handleChange = <span class="function">(<span class="params">&#123; file, fileList &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(file)); <span class="comment">// file 是当前正在上传的 单个 img</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(fileList)); <span class="comment">// fileList 是已上传的全部 img 列表</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">imgList</span>: fileList,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  handleCancel = <span class="function">() =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">previewVisible</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">  handlePreview = <span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">previewImage</span>: file.url || file.thumbUrl,</span><br><span class="line">      <span class="attr">previewVisible</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参考链接：https://www.jianshu.com/p/f356f050b3c9</span></span><br><span class="line">  handleBeforeUpload = <span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//限制图片 格式、size、分辨率</span></span><br><span class="line">    <span class="keyword">const</span> isJPG = file.type === <span class="string">&#x27;image/jpeg&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isJPEG = file.type === <span class="string">&#x27;image/jpeg&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isGIF = file.type === <span class="string">&#x27;image/gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isPNG = file.type === <span class="string">&#x27;image/png&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(isJPG || isJPEG || isGIF || isPNG)) &#123;</span><br><span class="line">      Modal.error(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;只能上传JPG 、JPEG 、GIF、 PNG格式的图片~&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> isLt2M = file.size / <span class="number">1024</span> / <span class="number">1024</span> &lt; <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isLt2M) &#123;</span><br><span class="line">      Modal.error(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;超过2M限制，不允许上传~&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (isJPG || isJPEG || isGIF || isPNG) &amp;&amp; isLt2M &amp;&amp; <span class="built_in">this</span>.checkImageWH(file);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传</span></span><br><span class="line">  <span class="function"><span class="title">checkImageWH</span>(<span class="params">file</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> self = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> filereader = <span class="keyword">new</span> FileReader();</span><br><span class="line">      filereader.onload = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> src = e.target.result;</span><br><span class="line">        <span class="keyword">const</span> image = <span class="keyword">new</span> Image();</span><br><span class="line">        image.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="comment">// 获取图片的宽高，并存放到file对象中</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;file width :&#x27;</span> + <span class="built_in">this</span>.width);</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;file height :&#x27;</span> + <span class="built_in">this</span>.height);</span><br><span class="line">          file.width = <span class="built_in">this</span>.width;</span><br><span class="line">          file.height = <span class="built_in">this</span>.height;</span><br><span class="line">          resolve();</span><br><span class="line">        &#125;;</span><br><span class="line">        image.onerror = reject;</span><br><span class="line">        image.src = src;</span><br><span class="line">      &#125;;</span><br><span class="line">      filereader.readAsDataURL(file);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleSubmit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; dispatch, form &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">    form.validateFieldsAndScroll(<span class="function">(<span class="params">err, values</span>) =&gt;</span> &#123;<span class="comment">// values 是form表单里的参数</span></span><br><span class="line">      <span class="comment">// 点击按钮后，将表单提交给后台</span></span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;mymodel/submitFormData&#x27;</span>,</span><br><span class="line">        <span class="attr">payload</span>: values,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; previewVisible, previewImage, imgList &#125; = <span class="built_in">this</span>.state; <span class="comment">//  从 state 中拿数据</span></span><br><span class="line">    <span class="keyword">const</span> uploadButton = (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;plus&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;ant-upload-text&quot;</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;clearfix&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;this.handleSubmit&#125;</span> <span class="attr">hideRequiredMark</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span> <span class="attr">8</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;图片图片&quot;</span> &#123;<span class="attr">...formItemLayout</span>&#125;&gt;</span></span></span><br><span class="line"><span class="xml">            &#123;getFieldDecorator(&#x27;myImg&#x27;)(</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;<span class="name">Upload</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">action</span>=<span class="string">&quot;//jsonplaceholder.typicode.com/posts/&quot;</span> // 这个是图片上传的接口请求，实际开发中，要替换成你自己的业务接口</span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">data</span>=<span class="string">&#123;file</span> =&gt;</span> (&#123; // data里存放的是接口的请求参数</span></span><br><span class="line"><span class="xml">                  param1: myParam1,</span></span><br><span class="line"><span class="xml">                  param2: myParam2,</span></span><br><span class="line"><span class="xml">                  photoCotent: file, // file 是当前正在上传的图片</span></span><br><span class="line"><span class="xml">                  photoWidth: file.height, // 通过  handleBeforeUpload 获取 图片的宽高</span></span><br><span class="line"><span class="xml">                  photoHeight: file.width,</span></span><br><span class="line"><span class="xml">                &#125;)&#125;</span></span><br><span class="line"><span class="xml">                listType=&quot;picture-card&quot;</span></span><br><span class="line"><span class="xml">                fileList=&#123;this.state.imgList&#125;</span></span><br><span class="line"><span class="xml">                onPreview=&#123;this.handlePreview&#125; // 点击图片缩略图，进行预览</span></span><br><span class="line"><span class="xml">                beforeUpload=&#123;this.handleBeforeUpload&#125; // 上传之前，对图片的格式做校验，并获取图片的宽高</span></span><br><span class="line"><span class="xml">                onChange=&#123;this.handleChange&#125; // 每次上传图片时，都会触发这个方法</span></span><br><span class="line"><span class="xml">              &gt;</span></span><br><span class="line"><span class="xml">                &#123;this.state.imgList.length &gt;= 9 ? null : uploadButton&#125;</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;/<span class="name">Upload</span>&gt;</span></span></span><br><span class="line"><span class="xml">            )&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Modal</span> <span class="attr">visible</span>=<span class="string">&#123;previewVisible&#125;</span> <span class="attr">footer</span>=<span class="string">&#123;null&#125;</span> <span class="attr">onCancel</span>=<span class="string">&#123;this.handleCancel&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;example&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> &#x27;<span class="attr">100</span>%&#x27; &#125;&#125; <span class="attr">src</span>=<span class="string">&#123;previewImage&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Modal</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PicturesWall;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="上传后，点击图片预览，浏览器卡死的问题"><a href="#上传后，点击图片预览，浏览器卡死的问题" class="headerlink" title="上传后，点击图片预览，浏览器卡死的问题"></a>上传后，点击图片预览，浏览器卡死的问题</h2><p>依据上方的代码，通过 Antd 的 upload 组件将图片上传成功后，点击图片的缩略图，理应可以在当前页面弹出  Modal，预览图片。但实际的结果是，浏览器一定会卡死。</p>
<p>定位问题发现，原因竟然是：图片上传成功后， upload 会将其转为 base64编码。base64这个字符串太大了，点击图片预览的时候，浏览器在解析一大串字符串，然后就卡死了。详细过程描述如下。</p>
<p>上方代码中，我们可以把 handleChange(file, fileList)方法中的 <code>file</code>、以及 <code>fileList</code>打印出来看看。 <code>file</code>指的是当前正在上传的 单个 img，<code>fileList</code>是已上传的全部 img 列表。 当我上传完 两张图片后， 打印结果如下：</p>
<p>file的打印的结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;rc-upload-1551084269812-5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;width&quot;</span>: <span class="number">600</span>,</span><br><span class="line">    <span class="attr">&quot;height&quot;</span>: <span class="number">354</span>,</span><br><span class="line">    <span class="attr">&quot;lastModified&quot;</span>: <span class="number">1546701318000</span>,</span><br><span class="line">    <span class="attr">&quot;lastModifiedDate&quot;</span>: <span class="string">&quot;2019-01-05T15:15:18.000Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;e30e7b9680634b2c888c8bb513cc595d.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">31731</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/jpeg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;percent&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;originFileObj&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;rc-upload-1551084269812-5&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;width&quot;</span>: <span class="number">600</span>,</span><br><span class="line">        <span class="attr">&quot;height&quot;</span>: <span class="number">354</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;done&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;thumbUrl&quot;</span>: <span class="string">&quot;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;response&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;retCode&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;imgUrl&quot;</span>: <span class="string">&quot;http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;photoid&quot;</span>: <span class="number">271850</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fileList 的打印结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;rc-upload-1551084269812-3&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;width&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">&quot;height&quot;</span>: <span class="number">667</span>,</span><br><span class="line">        <span class="attr">&quot;lastModified&quot;</span>: <span class="number">1501414799000</span>,</span><br><span class="line">        <span class="attr">&quot;lastModifiedDate&quot;</span>: <span class="string">&quot;2017-07-30T11:39:59.000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;29381f30e924b89914e91b33.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">135204</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/jpeg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;percent&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">&quot;originFileObj&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;rc-upload-1551084269812-3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;width&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="attr">&quot;height&quot;</span>: <span class="number">667</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;done&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;thumbUrl&quot;</span>: <span class="string">&quot;data:image/jpeg;base64,/E3ju1tlaK1fzJOnHQU3LsLV7HO6Zrk11MZJ7luT0A4FZuRagi9quvzQQ4iuEJ7ZpqTG4djDsPFl2Lg733f8C4q+YhQ8zoYfGSqoMmfwo5huLL0HjiyPDSYPvxRdC1XQvxeLrB8fvl/OnoLmL9vrdvvYS3NGFVe2YsASOh71JfQyrqV2mXLHOcccVSIYEnDyZO9XXB9KYH//Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;response&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;retCode&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;msg&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;imgUrl&quot;</span>: <span class="string">&quot;http://qianguyihao.com/hfwpjouiurewnmbhepr689.jpg&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;rc-upload-1551084269812-5&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;width&quot;</span>: <span class="number">600</span>,</span><br><span class="line">        <span class="attr">&quot;height&quot;</span>: <span class="number">354</span>,</span><br><span class="line">        <span class="attr">&quot;lastModified&quot;</span>: <span class="number">1546701318000</span>,</span><br><span class="line">        <span class="attr">&quot;lastModifiedDate&quot;</span>: <span class="string">&quot;2019-01-05T15:15:18.000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;e30e7b9680634b2c888c8bb513cc595d.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">31731</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;image/jpeg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;percent&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="attr">&quot;originFileObj&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;rc-upload-1551084269812-5&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;width&quot;</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">&quot;height&quot;</span>: <span class="number">354</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;done&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;thumbUrl&quot;</span>: <span class="string">&quot;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;response&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;retCode&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">&quot;imgUrl&quot;</span>: <span class="string">&quot;http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;photoid&quot;</span>: <span class="number">271850</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>上方的json数据中，需要做几点解释：</p>
<p>（1）<code>response</code> 字段里面的数据，就是请求接口后，后台返回给前端的数据，里面包含了图片的url链接。</p>
<p>（2）<code>status</code> 字段里存放的是图片上传的实时状态，包括上传中、上传完成、上传失败。</p>
<p>（3）<code>thumbUrl</code>字段里面存放的是图片的base64编码。</p>
<p>这个base64编码非常非常长。当点击图片预览的时候，其实就是加载的 thumbUrl 这个字段里的资源，难怪浏览器会卡死。</p>
<p><strong>解决办法</strong>：在 handleChange方法里，图片上传成功后，将 thumbUrl 字段里面的 base64 编码改为真实的图片url。代码实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">handleChange = <span class="function">(<span class="params">&#123; file, fileList &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(file)); <span class="comment">// file 是当前正在上传的 单个 img</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(fileList)); <span class="comment">// fileList 是已上传的全部 img 列表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。</span></span><br><span class="line">  <span class="comment">// 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。</span></span><br><span class="line">  fileList.forEach(<span class="function"><span class="params">imgItem</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (imgItem &amp;&amp; imgItem.status == <span class="string">&#x27;done&#x27;</span> &amp;&amp; imgItem.response &amp;&amp; imgItem.response.imgUrl) &#123;</span><br><span class="line">      imgItem.thumbUrl = imgItem.response.imgUrl;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">    <span class="attr">imgList</span>: fileList,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h2 id="新需求：编辑现有页面"><a href="#新需求：编辑现有页面" class="headerlink" title="新需求：编辑现有页面"></a>新需求：编辑现有页面</h2><p>上面一段的代码中，我们是在新建的页面中，从零开始上传图片。</p>
<p>现在有个新的需求：如何编辑现有的页面呢？也就是说，现有的页面在初始化时，是默认有几张图片的。当我编辑这个页面时，可以对现有的图片做增删，也能增加新的图片。而且要保证：新建页面和编辑现有页面，是共用一套代码。</p>
<p>我看到upload 组件有提供 <code>defaultFileList</code> 的属性。我试了下，这个<code>defaultFileList</code> 的属性根本没法儿用。</p>
<p>那就只有手动实现了。我的model层代码，是用 redux 写的。整体的实现思路如下：（这个也是在真正在实战中用到的代码）</p>
<p>（1）PicturesWall.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; Upload, Icon, Modal, Form &#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FormItem = Form.Item;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PicturesWall</span> <span class="keyword">extends</span> <span class="title">PureComponent</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">previewVisible</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">previewImage</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 页面初始化的时候，从接口拉取默认的图片数据</span></span><br><span class="line">  <span class="function"><span class="title">componentDidMount</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; dispatch &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;mymodel/getAllInfo&#x27;</span>,</span><br><span class="line">      <span class="attr">payload</span>: &#123; <span class="attr">params</span>: xxx &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleChange = <span class="function">(<span class="params">&#123; file, fileList &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; dispatch &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    <span class="comment">// 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。</span></span><br><span class="line">    <span class="comment">// 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。</span></span><br><span class="line">    fileList.forEach(<span class="function"><span class="params">imgItem</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (imgItem &amp;&amp; imgItem.status == <span class="string">&#x27;done&#x27;</span> &amp;&amp; imgItem.response &amp;&amp; imgItem.response.imgUrl) &#123;</span><br><span class="line">        imgItem.thumbUrl = imgItem.response.imgUrl;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;mymodel/setImgList&#x27;</span>,</span><br><span class="line">      <span class="attr">payload</span>: fileList,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleCancel = <span class="function">() =&gt;</span> <span class="built_in">this</span>.setState(&#123; <span class="attr">previewVisible</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line">  handlePreview = <span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(&#123;</span><br><span class="line">      <span class="attr">previewImage</span>: file.url || file.thumbUrl,</span><br><span class="line">      <span class="attr">previewVisible</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参考链接：https://www.jianshu.com/p/f356f050b3c9</span></span><br><span class="line">  handleBeforeUpload = <span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//限制图片 格式、size、分辨率</span></span><br><span class="line">    <span class="keyword">const</span> isJPG = file.type === <span class="string">&#x27;image/jpeg&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isJPEG = file.type === <span class="string">&#x27;image/jpeg&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isGIF = file.type === <span class="string">&#x27;image/gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isPNG = file.type === <span class="string">&#x27;image/png&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> isLt2M = file.size / <span class="number">1024</span> / <span class="number">1024</span> &lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(isJPG || isJPEG || isGIF || isPNG)) &#123;</span><br><span class="line">      Modal.error(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;只能上传JPG 、JPEG 、GIF、 PNG格式的图片~&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isLt2M) &#123;</span><br><span class="line">      Modal.error(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;超过2M限制，不允许上传~&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参考链接：https://github.com/ant-design/ant-design/issues/8779</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(isJPG || isJPEG || isGIF || isPNG)) &#123;</span><br><span class="line">        reject(file);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(file &amp;&amp; <span class="built_in">this</span>.checkImageWH(file));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传</span></span><br><span class="line">  <span class="function"><span class="title">checkImageWH</span>(<span class="params">file</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> self = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">let</span> filereader = <span class="keyword">new</span> FileReader();</span><br><span class="line">      filereader.onload = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> src = e.target.result;</span><br><span class="line">        <span class="keyword">const</span> image = <span class="keyword">new</span> Image();</span><br><span class="line">        image.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="comment">// 获取图片的宽高，并存放到file对象中</span></span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;file width :&#x27;</span> + <span class="built_in">this</span>.width);</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&#x27;file height :&#x27;</span> + <span class="built_in">this</span>.height);</span><br><span class="line">          file.width = <span class="built_in">this</span>.width;</span><br><span class="line">          file.height = <span class="built_in">this</span>.height;</span><br><span class="line">          resolve();</span><br><span class="line">        &#125;;</span><br><span class="line">        image.onerror = reject;</span><br><span class="line">        image.src = src;</span><br><span class="line">      &#125;;</span><br><span class="line">      filereader.readAsDataURL(file);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleSubmit = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; dispatch, form &#125; = <span class="built_in">this</span>.props;</span><br><span class="line">    e.preventDefault();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      <span class="attr">mymodel</span>: &#123; imgList &#125;, <span class="comment">// 从props中拿默认的图片数据</span></span><br><span class="line">    &#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    form.validateFieldsAndScroll(<span class="function">(<span class="params">err, values</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// values 是form表单里的参数</span></span><br><span class="line">      <span class="comment">// 点击按钮后，将表单提交给后台</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// start 问题描述：当编辑现有页面时，如果针对已经存在的默认图片不做修改，则不会触发 upload 的 onChange方法。此时提交表单，表单里的 myImg 字段是空的。</span></span><br><span class="line">      <span class="comment">// 解决办法：如果发现存在默认图片，则追加到表单中</span></span><br><span class="line">      <span class="keyword">if</span> (!values.myImg) &#123;</span><br><span class="line"></span><br><span class="line">        values.myImg = &#123; <span class="attr">fileList</span>: [] &#125;;</span><br><span class="line"></span><br><span class="line">        values.myImg.fileList = imgList;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// end</span></span><br><span class="line"></span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;mymodel/submitFormData&#x27;</span>,</span><br><span class="line">        <span class="attr">payload</span>: values,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; previewVisible, previewImage &#125; = <span class="built_in">this</span>.state; <span class="comment">//  从 state 中拿数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      <span class="attr">mymodel</span>: &#123; imgList &#125;, <span class="comment">// 从props中拿到的图片数据</span></span><br><span class="line">    &#125; = <span class="built_in">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uploadButton = (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;plus&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;ant-upload-text&quot;</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;clearfix&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Form</span> <span class="attr">onSubmit</span>=<span class="string">&#123;this.handleSubmit&#125;</span> <span class="attr">hideRequiredMark</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span> <span class="attr">8</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;图片上传&quot;</span> &#123;<span class="attr">...formItemLayout</span>&#125;&gt;</span></span></span><br><span class="line"><span class="xml">            &#123;getFieldDecorator(&#x27;myImg&#x27;)(</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;<span class="name">Upload</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">action</span>=<span class="string">&quot;//jsonplaceholder.typicode.com/posts/&quot;</span> // 这个是图片上传的接口请求，实际开发中，要替换成你自己的业务接口</span></span></span><br><span class="line"><span class="tag"><span class="xml">                <span class="attr">data</span>=<span class="string">&#123;file</span> =&gt;</span> (&#123;</span></span><br><span class="line"><span class="xml">                  // data里存放的是接口的请求参数</span></span><br><span class="line"><span class="xml">                  param1: myParam1,</span></span><br><span class="line"><span class="xml">                  param2: myParam2,</span></span><br><span class="line"><span class="xml">                  photoCotent: file, // file 是当前正在上传的图片</span></span><br><span class="line"><span class="xml">                  photoWidth: file.height, // 通过  handleBeforeUpload 获取 图片的宽高</span></span><br><span class="line"><span class="xml">                  photoHeight: file.width,</span></span><br><span class="line"><span class="xml">                &#125;)&#125;</span></span><br><span class="line"><span class="xml">                listType=&quot;picture-card&quot;</span></span><br><span class="line"><span class="xml">                fileList=&#123;imgList&#125;  // 改为从 props 里拿图片数据，而不是从 state</span></span><br><span class="line"><span class="xml">                onPreview=&#123;this.handlePreview&#125; // 点击图片缩略图，进行预览</span></span><br><span class="line"><span class="xml">                beforeUpload=&#123;this.handleBeforeUpload&#125; // 上传之前，对图片的格式做校验，并获取图片的宽高</span></span><br><span class="line"><span class="xml">                onChange=&#123;this.handleChange&#125; // 每次上传图片时，都会触发这个方法</span></span><br><span class="line"><span class="xml">              &gt;</span></span><br><span class="line"><span class="xml">                &#123;this.state.imgList.length &gt;= 9 ? null : uploadButton&#125;</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;/<span class="name">Upload</span>&gt;</span></span></span><br><span class="line"><span class="xml">            )&#125;</span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">Modal</span> <span class="attr">visible</span>=<span class="string">&#123;previewVisible&#125;</span> <span class="attr">footer</span>=<span class="string">&#123;null&#125;</span> <span class="attr">onCancel</span>=<span class="string">&#123;this.handleCancel&#125;</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;example&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> &#x27;<span class="attr">100</span>%&#x27; &#125;&#125; <span class="attr">src</span>=<span class="string">&#123;previewImage&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">Modal</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> PicturesWall;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（2）mymodel.js:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; routerRedux &#125; <span class="keyword">from</span> <span class="string">&#x27;dva/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; message, Modal &#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  getGoodsInfo,</span><br><span class="line">  getAllGoods,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;../services/api&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; trim, getCookie &#125; <span class="keyword">from</span> <span class="string">&#x27;../utils/utils&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">&#x27;mymodel&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">form</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">list</span>: [],</span><br><span class="line">    <span class="attr">listDetail</span>: [],</span><br><span class="line">    <span class="attr">goodsList</span>: [],</span><br><span class="line">    <span class="attr">goodsListDetail</span>: [],</span><br><span class="line">    <span class="attr">pagination</span>: &#123;</span><br><span class="line">      <span class="attr">pageSize</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">total</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">current</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">imgList</span>: [], <span class="comment">//图片</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">subscriptions</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">setup</span>(<span class="params">&#123; dispatch, history &#125;</span>)</span> &#123;</span><br><span class="line">      history.listen(<span class="function"><span class="params">location</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (location.pathname !== <span class="string">&#x27;/xx/xxx&#x27;</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (!location.state || !location.state.xxxId) <span class="keyword">return</span>;</span><br><span class="line">        dispatch(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;fetch&#x27;</span>,</span><br><span class="line">          <span class="attr">payload</span>: location.state,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">effects</span>: &#123;</span><br><span class="line">    <span class="comment">// 接口。获取所有工厂店的列表 (步骤02)</span></span><br><span class="line">    *<span class="function"><span class="title">getAllInfo</span>(<span class="params">&#123; payload &#125;, &#123; select, call, put &#125;</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;form&#x27;</span>,</span><br><span class="line">        payload,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;params:&#x27;</span> + <span class="built_in">JSON</span>.stringify(payload));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> params = &#123;&#125;;</span><br><span class="line">      params = payload;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">yield</span> call(getGoodsInfo, params);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae response:&#x27;</span> + <span class="built_in">JSON</span>.stringify(response));</span><br><span class="line">      <span class="keyword">if</span> (response.error) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;allInfo&#x27;</span>,</span><br><span class="line">        <span class="attr">payload</span>:</span><br><span class="line">          (response.data &amp;&amp;</span><br><span class="line">            response.data.map(<span class="function"><span class="params">item</span> =&gt;</span> (&#123;</span><br><span class="line">              <span class="attr">xx1</span>: item.yy1,</span><br><span class="line">              <span class="attr">xx2</span>: item.yy2,</span><br><span class="line">            &#125;))) ||</span><br><span class="line">          [],</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// response 里包含了接口返回给前端的默认图片数据</span></span><br><span class="line">      <span class="keyword">if</span> (response &amp;&amp; response.data &amp;&amp; response.data[<span class="number">0</span>] &amp;&amp; response.data[<span class="number">0</span>].my_jpg) &#123;</span><br><span class="line">        <span class="keyword">let</span> tempImgList = response.data[<span class="number">0</span>].my_jpg.split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        <span class="keyword">let</span> imgList = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tempImgList.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          tempImgList.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">            imgList.push(&#123;</span><br><span class="line">              <span class="attr">uid</span>: item,</span><br><span class="line">              <span class="attr">name</span>: <span class="string">&#x27;xxx.png&#x27;</span>,</span><br><span class="line">              <span class="attr">status</span>: <span class="string">&#x27;done&#x27;</span>,</span><br><span class="line">              <span class="attr">thumbUrl</span>: item,</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过  redux的方式 将 默认图片 传给 imgList</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;smyhvae payload imgList:&#x27;</span> + <span class="built_in">JSON</span>.stringify(imgList));</span><br><span class="line">        <span class="keyword">yield</span> put(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;setImgList&#x27;</span>,</span><br><span class="line">          <span class="attr">payload</span>: imgList,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    *<span class="function"><span class="title">setImgList</span>(<span class="params">&#123; payload &#125;, &#123; call, put &#125;</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;model setImgList&#x27;</span>);</span><br><span class="line">      <span class="keyword">yield</span> put(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;getImgList&#x27;</span>,</span><br><span class="line">        payload,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">allInfo</span>(<span class="params">state, action</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">list</span>: action.payload,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">getImgList</span>(<span class="params">state, action</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">imgList</span>: action.payload,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面的代码，可以规避 upload 组件的一些bug；而且可以在上传前，通过校验图片的尺寸、大小等，如果不满足条件，则弹出modal弹窗，阻止上传。</p>
<p>大功告成。本文感谢 ld 同学的支持。</p>
<p>更多内容，可以看本人的另外一篇文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/qianguyihao/p/13093592.html">AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为</a></li>
</ul>
<h2 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ant-design/ant-design/issues/8779">beforeUpload返回false后，文件仍然为上传中的状态</a></li>
</ul>
<h2 id="最后一段"><a href="#最后一段" class="headerlink" title="最后一段"></a>最后一段</h2><p>有人说，前端开发，连卖菜的都会。可如果真的遇到技术难题，还是得找个靠谱的前端同学才行。这不，来看看前端码农日常：</p>
<p><img src="http://img.smyhvae.com/20190302_1339_2.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/17/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/19/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">张天伟</p>
  <div class="site-description" itemprop="description">欢迎访问！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">261</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张天伟</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
